<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>胖大人的日常记事</title>
    <meta name="description" content="Just playing around">
    <link rel="icon" href="/logo.ico">
  <link rel="manifest" href="/manifest.json">
    
    <link rel="preload" href="/assets/css/0.styles.d6cdabc1.css" as="style"><link rel="preload" href="/assets/js/app.92625234.js" as="script"><link rel="preload" href="/assets/js/2.38d85b4c.js" as="script"><link rel="preload" href="/assets/js/26.60483ab2.js" as="script"><link rel="prefetch" href="/assets/js/10.1a50f243.js"><link rel="prefetch" href="/assets/js/11.bad254af.js"><link rel="prefetch" href="/assets/js/12.56baed48.js"><link rel="prefetch" href="/assets/js/13.7055bfb2.js"><link rel="prefetch" href="/assets/js/14.eb7e1e0e.js"><link rel="prefetch" href="/assets/js/15.20ae4527.js"><link rel="prefetch" href="/assets/js/16.53f5f52a.js"><link rel="prefetch" href="/assets/js/17.559421a0.js"><link rel="prefetch" href="/assets/js/18.2a06a394.js"><link rel="prefetch" href="/assets/js/19.42604d4f.js"><link rel="prefetch" href="/assets/js/20.52090e26.js"><link rel="prefetch" href="/assets/js/21.dd9ac026.js"><link rel="prefetch" href="/assets/js/22.21f5f57a.js"><link rel="prefetch" href="/assets/js/23.b2f0989f.js"><link rel="prefetch" href="/assets/js/24.ec557b6b.js"><link rel="prefetch" href="/assets/js/25.6644ec66.js"><link rel="prefetch" href="/assets/js/27.3798eaab.js"><link rel="prefetch" href="/assets/js/28.8d842cc3.js"><link rel="prefetch" href="/assets/js/29.7c4d8f6b.js"><link rel="prefetch" href="/assets/js/3.a2e674c2.js"><link rel="prefetch" href="/assets/js/30.b105f212.js"><link rel="prefetch" href="/assets/js/31.01c7643e.js"><link rel="prefetch" href="/assets/js/32.45e721ae.js"><link rel="prefetch" href="/assets/js/33.567b3ff4.js"><link rel="prefetch" href="/assets/js/34.d9579cd9.js"><link rel="prefetch" href="/assets/js/35.3a605990.js"><link rel="prefetch" href="/assets/js/36.7321ee72.js"><link rel="prefetch" href="/assets/js/37.663a1ee1.js"><link rel="prefetch" href="/assets/js/4.6352c09c.js"><link rel="prefetch" href="/assets/js/5.ae17a9ef.js"><link rel="prefetch" href="/assets/js/6.c1d31416.js"><link rel="prefetch" href="/assets/js/7.a0ef9559.js"><link rel="prefetch" href="/assets/js/8.817ff80f.js"><link rel="prefetch" href="/assets/js/9.d271e8c5.js">
    <link rel="stylesheet" href="/assets/css/0.styles.d6cdabc1.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">胖大人的日常记事</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">Home</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">Home</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/0001.html" class="sidebar-link">01 开篇词 | 使用 Webpack 实现前端工程化</a></li><li><a href="/0002.html" class="sidebar-link">02 什么是 Webpack</a></li><li><a href="/0003.html" class="sidebar-link">03 Webpack 开发环境搭建</a></li><li><a href="/0004.html" class="sidebar-link">04 使用 webpack-cli 体验零配置打包</a></li><li><a href="/0005.html" class="sidebar-link">05 基础概念和常见配置项介绍（一）</a></li><li><a href="/0006.html" class="sidebar-link">06 基础概念和常见配置项介绍（二）</a></li><li><a href="/0007.html" class="sidebar-link">07 Webpack 中的模块化开发</a></li><li><a href="/0008.html" class="sidebar-link">08 在 Webpack 中使用 Babel 转换 JavaScript 代码</a></li><li><a href="/0009.html" class="sidebar-link">09 Webpack 中使用 TypeScript 开发项目</a></li><li><a href="/0010.html" class="sidebar-link">10 Webpack 中样式相关的配置</a></li><li><a href="/0011.html" class="sidebar-link">11 Webpack 中使用 lint 工具来保证代码风格和质量</a></li><li><a href="/0012.html" class="sidebar-link">12 使用 Webpack 管理项目中的静态资源</a></li><li><a href="/0013.html" class="sidebar-link">13 Webpack 中打包 HTML 和多页面配置</a></li><li><a href="/0014.html" class="sidebar-link">14 Webpack Dev Server 本地开发服务</a></li><li><a href="/0015.html" class="sidebar-link">15 Webpack 中配置React和Vue开发环境</a></li><li><a href="/0016.html" class="sidebar-link">16 Webpack 环境相关配置及配置文件拆分</a></li><li><a href="/0017.html" class="sidebar-link">17 Webpack 优化之体积优化</a></li><li><a href="/0018.html" class="sidebar-link">18 Webpack 优化之增强缓存命中率</a></li><li><a href="/0019.html" class="sidebar-link">19 使用 Webpack 的 splitChunks 功能来拆分代码</a></li><li><a href="/0020.html" class="sidebar-link">20 Webpack 优化之速度优化</a></li><li><a href="/0021.html" class="active sidebar-link">21 使用 Webpack 的 Tree-Shaking</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/0021.html#tree-shaking-实现原理" class="sidebar-link">Tree-Shaking 实现原理</a></li><li class="sidebar-sub-header"><a href="/0021.html#webpack-tree-shaking-代码实战" class="sidebar-link">Webpack Tree-Shaking 代码实战</a></li><li class="sidebar-sub-header"><a href="/0021.html#tree-shaking-并不是银弹" class="sidebar-link">Tree-Shaking 并不是银弹</a></li><li class="sidebar-sub-header"><a href="/0021.html#总结" class="sidebar-link">总结</a></li></ul></li><li><a href="/0022.html" class="sidebar-link">22 为你准备了一份 Webpack 工程化最佳实践总结</a></li><li><a href="/0023.html" class="sidebar-link">23 怎么调试 Webpack？</a></li><li><a href="/0024.html" class="sidebar-link">24 Tapable —— Webpack 的核心模块</a></li><li><a href="/0025.html" class="sidebar-link">25 Webpack 的 Compiler 和 Compilation</a></li><li><a href="/0026.html" class="sidebar-link">26 Webpack 工作流程</a></li><li><a href="/0027.html" class="sidebar-link">27 从 Webpack 的产出代码来看 Webpack 是怎么执行的</a></li><li><a href="/0028.html" class="sidebar-link">28 Webpack 的模块热替换做了什么？</a></li><li><a href="/0029.html" class="sidebar-link">29 实战：使用 PostCSS 打造移动适配方案</a></li><li><a href="/0030.html" class="sidebar-link">30 实战：手写一个 markdown-loader</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p><img src="https://img1.mukewang.com/5cd9641e0001c6c306390359.jpg" alt=""></p> <blockquote><p>你若要喜爱你自己的价值，你就得给世界创造价值。</p> <p>               —— 歌德</p></blockquote> <p>Tree-Shaking 是一个前端术语，本意为摇树的意思，在前端术语中通常用于描述移除 JavaScript 上下文中没用的代码，这样可以有效地缩减打包体积。关于 Tree-Shaking，Webpack 官方文档有一段很形象的描述：</p> <p>你可以将应用程序想象成一棵树。绿色表示实际用到的源码和 library，是树上活的树叶。灰色表示无用的代码，是秋天树上枯萎的树叶。为了除去死去的树叶，你必须摇动这棵树，使它们落下。</p> <p><img src="http://img.mukewang.com/5d0c3ee100018fa304120232.gif" alt=""></p> <p>Tree-Shaking 最早是由 Rich Harris 在打包工具 rollup.js提出并且实现的，其实在更早，Google Closure Compiler 也做过类似的事情。在 Webpack 2 中吸取了 Tree-Shaking 功能，并且在 Webpack 中得到实现。</p> <h2 id="tree-shaking-实现原理"><a href="#tree-shaking-实现原理" aria-hidden="true" class="header-anchor">#</a> Tree-Shaking 实现原理</h2> <p>Tree-Shaking 的本质是消除无用的 JavaScript 代码。无用代码消除（Dead Code Elimination）广泛存在于传统的编程语言编译器中，编译器可以判断出某些代码根本不影响输出，然后消除这些代码，这个称之为 DCE（Dead Code Elimination）。Tree-Shaking 是 DCE 的一种新的实现，Javascript 同传统的编程语言不同的是，JavaScript 绝大多数情况是在浏览器中执行，需要通过网络进行加载，然后解析 JavaScript 文件再执行。</p> <p>2018 年年中，据 HTTP Archive 统计：移动端 JavaScript 文件的平均传输大小将近 350KB。你要知道，这仅仅是传输的大小。在网络传输的时候，JavaScript 往往是经过压缩的。也就是说，在浏览器解压缩之前，实际的大小会远远大于这个值。而这一点相当重要。如果考虑到浏览器处理数据的资源消耗，其中压缩是不得不考虑的。一个 300KB 的文件解压缩会达到 900KB，并且在分析和编译的时候，体积依然是 900KB。</p> <p><img src="http://img.mukewang.com/5d0760130001c44208260174.jpg" alt=""></p> <p>由于网络的带宽限制，加载的 JavaScript 文件体积越小，整体解析执行时间更短，所以去除无用代码以减少文件体积，对 JavaScript 来说更有意义。</p> <p>Tree-Shaking 和传统的 DCE 的方法又不太一样，传统的 DCE 消灭不可能执行的代码：</p> <p>程序中没有执行的代码，如不可能进入的分支，return 之后的语句等；
导致 dead variable 的代码，写入变量之后不再读取的代码。
和 DCE 不同的是，Tree-Shaking 则更关注于消除没有用到的代码。通过之前的章节介绍过，Webpack 是基于 ES6 Modules 静态语法解析的构建工具，Tree-Shaking 之所以能够在 Webpack 实现，也是得益于 ES6 Modules 静态解析的特性。ES6 的模块声明保证了依赖关系是提前确定的，使得静态分析成为可能，这样在 Webpack 中代码不需要执行就可以知道是否被使用，自然就知道哪些是无用的代码了。</p> <p>ES6 Modules 特点：</p> <ul><li>ES6 中<code>import</code>和<code>export</code>是显性声明的；</li> <li>import 的模块名只能是字符串常量；</li> <li>ES6 模块的依赖关系是可以根据import引用关系推导出来的。</li> <li>ES6 模块的依赖关系与运行时状态无关</li></ul> <p>上面这些 ES6 Modules 的特点是 Tree-Shaking 的基础。所谓静态分析就是不执行代码，从字面量上对代码进行分析，ES6 之前的模块化，比如我们可以动态 require 一个模块，只有执行后才知道引用的什么模块，这个就不能通过静态分析去做优化。这是 ES6 Modules 在设计时的一个重要考量，也是为什么没有直接采用 CommonJS，正是基于这个基础上，才使得 Tree-Shaking 成为可能，这也是为什么 rollup.js 和 Webpack 2 都要用 ES6 Module 语法才能实现 Tree-Shaking。</p> <h2 id="webpack-tree-shaking-代码实战"><a href="#webpack-tree-shaking-代码实战" aria-hidden="true" class="header-anchor">#</a> Webpack Tree-Shaking 代码实战</h2> <p>在 Webpack 中，Tree-Shaking 是需要配合<code>mode=production</code>来使用的，这是因为 Webpack 的 Tree-Shaking 实际分了两步来实现：</p> <p>Webpack 自己来分析 ES6 Modules 的引入和使用情况，去除不使用的import引入；
借助工具（如 <code>uglifyjs-webpack-plugin</code>和<code>terser-webpack-plugin</code>）进行删除，这些工具只在<code>mode=production</code>中会被使用。
我们通过实例来看下这两个步骤，首先我们准备了两个文件：utils.js和index.js文件，其中utils.js中定义了两个方法isNull和isNumber：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// utils.js</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">isNull</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'isNull'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span> <span class="token operator">===</span> obj<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">isNumber</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'isNumber'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token keyword">typeof</span> obj <span class="token operator">===</span> <span class="token string">'number'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>但是在index.js中import了utils的两个函数方法，但是实际却只用了isNull的方法：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// index.js</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>isNull<span class="token punctuation">,</span> isNumber<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./utils'</span><span class="token punctuation">;</span>

<span class="token function">isNull</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>下面我们使用<code>webpack --mode=development</code>打包看下结果：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token punctuation">{</span>
<span class="token string">'./src/index.js'</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> __webpack_exports__<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token string">'use strict'</span><span class="token punctuation">;</span>
    <span class="token comment">// 注意！注意！注意！</span>
    <span class="token comment">// 注意这里打包后_utils__WEBPACK_IMPORTED_MODULE_0__</span>
    __webpack_require__<span class="token punctuation">.</span><span class="token function">r</span><span class="token punctuation">(</span>__webpack_exports__<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* harmony import */</span> <span class="token keyword">var</span> _utils__WEBPACK_IMPORTED_MODULE_0__ <span class="token operator">=</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span>
        <span class="token comment">/*! ./utils */</span> <span class="token string">'./src/utils.js'</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">Object</span><span class="token punctuation">(</span>_utils__WEBPACK_IMPORTED_MODULE_0__<span class="token punctuation">[</span><span class="token string">'isNull'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token string">'./src/utils.js'</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> __webpack_exports__<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token string">'use strict'</span><span class="token punctuation">;</span>
    __webpack_require__<span class="token punctuation">.</span><span class="token function">r</span><span class="token punctuation">(</span>__webpack_exports__<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* harmony export (binding) */</span> __webpack_require__<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>__webpack_exports__<span class="token punctuation">,</span> <span class="token string">'isNull'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> isNull<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* harmony export (binding) */</span> __webpack_require__<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>__webpack_exports__<span class="token punctuation">,</span> <span class="token string">'isNumber'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> isNumber<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">function</span> <span class="token function">isNull</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'isNull'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span> <span class="token operator">===</span> obj<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">isNumber</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'isNumber'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token keyword">typeof</span> obj <span class="token operator">===</span> <span class="token string">'number'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>我们发现index.js的打包结果中，只保留了<code>isNull</code>的使用，而虽然我们同时<code>import</code>了<code>isNumber</code>和<code>isNull</code>，但最终<code>isNumber</code>并没有出现在<code>index.js</code>的打包结果内：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> __webpack_exports__<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token string">'use strict'</span><span class="token punctuation">;</span>
    <span class="token comment">// 注意！注意！注意！</span>
    <span class="token comment">// 注意这里打包后_utils__WEBPACK_IMPORTED_MODULE_0__</span>
    __webpack_require__<span class="token punctuation">.</span><span class="token function">r</span><span class="token punctuation">(</span>__webpack_exports__<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* harmony import */</span> <span class="token keyword">var</span> _utils__WEBPACK_IMPORTED_MODULE_0__ <span class="token operator">=</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span>
        <span class="token comment">/*! ./utils */</span> <span class="token string">'./src/utils.js'</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">Object</span><span class="token punctuation">(</span>_utils__WEBPACK_IMPORTED_MODULE_0__<span class="token punctuation">[</span><span class="token string">'isNull'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre></div><p>但是utils.js打包后的内容没有变化，保留了isNumber的方法。</p> <p>这说明，Webpack 的 Tree-Shaking 第一步只不过是去掉了无用的引用，但是并没有删除无用的代码，<strong>删除无用的代码是mode=production时候使用压缩工具实现</strong>的。那么我们在使用<code>webpack --mode=production</code>来看下结果，格式化后，我们看到isNumber部分的关键字没有了（因为有console.log('isNumber')，可以搜索isNumber字符串关键字）：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token operator">!</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> t <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">//... 忽略内容</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token number">9</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e<span class="token punctuation">,</span> t<span class="token punctuation">,</span> r</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token string">'use strict'</span><span class="token punctuation">;</span>
        r<span class="token punctuation">.</span><span class="token function">r</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">,</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'isNull'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>到此，我们已经理解 <code>Tree-Shaking</code> 的原理和使用方法了。</p> <h2 id="tree-shaking-并不是银弹"><a href="#tree-shaking-并不是银弹" aria-hidden="true" class="header-anchor">#</a> Tree-Shaking 并不是银弹</h2> <p>通过上面的实验，可能大家认为 Tree-Shaking 已经很了不起了，可以帮助我们缩减代码，但是很多情况下 Tree-Shaking 并不是银弹！首先基于 Tree-Shaking 的原理，所以我们的代码必须遵循 ES6 的模块规范，即使用 import 和 export语法，如果是 CommonJS 规范（使用require）则无法使用 Tree-Shaking 功能。除了这点之外，在使用 Tree-Shaking 还有什么注意点或者 Tree-Shaking 处理不到的地方呢？</p> <h4 id="tree-shaking-处理-class"><a href="#tree-shaking-处理-class" aria-hidden="true" class="header-anchor">#</a> Tree-Shaking 处理 Class</h4> <p>下面我们再来看下 Tree-Shaking 对类的处理，首先创建一个class.js，内容如下：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// class.js</span>
<span class="token keyword">class</span> <span class="token class-name">Utils</span> <span class="token punctuation">{</span>
    <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'bar'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> Utils<span class="token punctuation">;</span>
</code></pre></div><p>然后我们在class-entry.js中引入这个Class，并且只是用foo的方法：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// class-entry.js</span>
<span class="token keyword">import</span> Utils <span class="token keyword">from</span> <span class="token string">'./class'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> u <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Utils</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>u<span class="token punctuation">.</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>我们希望 Tree-Shaking 能够帮我们把不使用的bar方法干掉，但是实际 Tree-Shaking 做不了这样的事情：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e<span class="token punctuation">,</span> t<span class="token punctuation">,</span> o</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token string">'use strict'</span><span class="token punctuation">;</span>
    o<span class="token punctuation">.</span><span class="token function">r</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> n <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">class</span> <span class="token punctuation">{</span>
        <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'bar'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这表明 webpack Tree-Shaking 只处理顶层内容，例如类和对象内部都不会再被分别处理，这主要也是由于 JavaScript 的动态语言特性所致，例如下面的代码：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> Utils <span class="token keyword">from</span> <span class="token string">'./class'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> u <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Utils</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>u<span class="token punctuation">[</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0.5</span> <span class="token operator">?</span> <span class="token string">'foo'</span> <span class="token punctuation">:</span> <span class="token string">'bar'</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>JavaScript 的编译器并不能识别一个方法名字究竟是以直接调用的形式出现（u.foo()）还是以字符串的形式（u<a href="">'foo'</a>）或者其他更加离奇的方式。因此误删方法只会导致运行出错，反而得不偿失。</p> <h4 id="副作用（side-effect）代码"><a href="#副作用（side-effect）代码" aria-hidden="true" class="header-anchor">#</a> 副作用（Side Effect）代码</h4> <p>知道函数式编程的朋友都会知道副作用（Side Effect）这个词，副作用会在我们项目中频繁的出现。我们称模块（函数）具有副作用，就是说这个模块是不纯的，这里可以引入纯函数的概念：</p> <p>对于相同的输入就有相同的输出，不依赖外部环境，也不改变外部环境。</p> <p>符合上面描述的函数就可以称为纯函数，不符合就是不纯的，不纯就具有副作用的，是可能对外界造成影响的。我们通过代码示例来理解下：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 函数内调用外部方法</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>isNumber<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'lodash-es'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">isNumber</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 直接使用全局对象</span>
<span class="token keyword">function</span> <span class="token function">goto</span><span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    location<span class="token punctuation">.</span>href <span class="token operator">=</span> url<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 直接修改原型</span>
<span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">hello</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token string">'hello'</span><span class="token punctuation">;</span>
</code></pre></div><p>上面几种方式的代码都是有副作用的代码，这样的代码在 Webpack 中因为并不知道代码内部究竟做了什么事情，所以不会被 Tree-Shaking 删除。那么怎么解决副作用呢？有两种方式：</p> <ul><li>代码中消除副作用；</li></ul> <p>配置sideEffects告诉 webpack 模块是安全的，不会带有副作用，可以放心优化。</p> <ul><li>代码中消除副作用</li></ul> <p>例如我们按照纯函数的定义，可以将需要用到的方法通过参数的方式传入：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 函数内调用外部方法</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">isNumber<span class="token punctuation">,</span> obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">isNumber</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 直接使用全局对象</span>
<span class="token keyword">function</span> <span class="token function">goto</span><span class="token punctuation">(</span><span class="token parameter">location<span class="token punctuation">,</span> url</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    location<span class="token punctuation">.</span>href <span class="token operator">=</span> url<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="配置sideeffects"><a href="#配置sideeffects" aria-hidden="true" class="header-anchor">#</a> 配置sideEffects</h4> <p>Webpack 的项目中，可以在package.json中使用sideEffects来告诉 webpack 哪些文件中的代码具有副作用，从而对没有副作用的文件代码可以放心的使用 Tree-Shaking 进行优化。</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token comment">// package.json</span>
<span class="token punctuation">{</span>
    <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;tree-shaking-side-effect&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;sideEffects&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;./src/utils.js&quot;</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>如果自己的项目是个类库或者工具库，需要发布给其他项目使用，并且项目是使用 ES6 Modules 编写的，没有副作用，那么可以在该项目<code>package.json</code>设置<code>sideEffects:false</code>来告诉使用该项目的 webpack 可以放心的对该项目进行 Tree-Shaking，而不必考虑副作用。</p> <h2 id="总结"><a href="#总结" aria-hidden="true" class="header-anchor">#</a> 总结</h2> <p>Tree-Shaking 对前端项目来说可谓意义重大，是一个极致优化的理想世界，是前端进化的又一个终极理想。但是理想是美好的，现实是骨感的，真正发挥 Tree-Shaking 的强大作用，还需要我们在日常的代码中保持良好的开发习惯：</p> <p>要使用 Tree-Shaking 必然要保证引用的模块都是 ES6 规范的，很多工具库或者类库都提供了 ES6 语法的库，例如 lodash 的 ES6 版本是lodash-es；
按需引入模块，避免「一把梭」，例如我们要使用 <code>lodash</code> 的<code>isNumber</code>，可以使用<code>import isNumber from 'lodash-es/isNumber'</code>;，而不是<code>import {isNumber} from 'lodash-es'</code>；</p> <p>减少代码中的副作用代码。</p> <blockquote><p><em><strong>Tips：</strong></em> 另外一些组件库，例如 AntDesign 和 ElementUI 这些组件库，本身自己开发了 Babel 的插件，通过插件的方式来按需引入模块，避免一股脑的引入全部组件。</p></blockquote> <p><strong>本小节 Webpack 相关面试题：</strong></p> <ol><li>什么是 Tree-Shaking？</li> <li>怎么在 Webpack 中做 Tree-Shaking？</li> <li>Webpack 中 Tree-Shaking 应该注意什么？</li></ol></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">9/13/2019, 2:49:43 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/0020.html" class="prev">20 Webpack 优化之速度优化</a></span> <span class="next"><a href="/0022.html">22 为你准备了一份 Webpack 工程化最佳实践总结</a>→
    </span></p></div> </main></div><div class="global-ui"><SWUpdatePopup></SWUpdatePopup></div></div>
    <script src="/assets/js/app.92625234.js" defer></script><script src="/assets/js/2.38d85b4c.js" defer></script><script src="/assets/js/26.60483ab2.js" defer></script>
  </body>
</html>

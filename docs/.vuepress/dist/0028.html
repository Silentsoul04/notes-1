<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>胖大人的日常记事</title>
    <meta name="description" content="Just playing around">
    <link rel="icon" href="logo.png">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#3eaf7c">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <link rel="apple-touch-icon" href="logo.png">
  <link rel="mask-icon" href="logo.svg" color="#3eaf7c">
  <meta name="msapplication-TileImage" content="logo_144*144.png">
  <meta name="msapplication-TileColor" content="#000000">
    
    <link rel="preload" href="/assets/css/0.styles.be15e0e1.css" as="style"><link rel="preload" href="/assets/js/app.745025a3.js" as="script"><link rel="preload" href="/assets/js/2.d6c01b35.js" as="script"><link rel="preload" href="/assets/js/33.d17510e5.js" as="script"><link rel="prefetch" href="/assets/js/10.b15f60e2.js"><link rel="prefetch" href="/assets/js/11.535b2ad8.js"><link rel="prefetch" href="/assets/js/12.46ffc8b5.js"><link rel="prefetch" href="/assets/js/13.4b23805e.js"><link rel="prefetch" href="/assets/js/14.6e6cf41b.js"><link rel="prefetch" href="/assets/js/15.47414791.js"><link rel="prefetch" href="/assets/js/16.ecc1171d.js"><link rel="prefetch" href="/assets/js/17.c118399e.js"><link rel="prefetch" href="/assets/js/18.eea3e35b.js"><link rel="prefetch" href="/assets/js/19.b12d698f.js"><link rel="prefetch" href="/assets/js/20.a584b4e7.js"><link rel="prefetch" href="/assets/js/21.3e0bdf10.js"><link rel="prefetch" href="/assets/js/22.276850a1.js"><link rel="prefetch" href="/assets/js/23.b3efca3c.js"><link rel="prefetch" href="/assets/js/24.c7601923.js"><link rel="prefetch" href="/assets/js/25.39614ac1.js"><link rel="prefetch" href="/assets/js/26.60483ab2.js"><link rel="prefetch" href="/assets/js/27.bfb61d9d.js"><link rel="prefetch" href="/assets/js/28.7dadd6bc.js"><link rel="prefetch" href="/assets/js/29.59b2df76.js"><link rel="prefetch" href="/assets/js/3.ded4051d.js"><link rel="prefetch" href="/assets/js/30.a7a4f806.js"><link rel="prefetch" href="/assets/js/31.48156b6a.js"><link rel="prefetch" href="/assets/js/32.e7ff8ffb.js"><link rel="prefetch" href="/assets/js/34.f00dca94.js"><link rel="prefetch" href="/assets/js/35.303cbcea.js"><link rel="prefetch" href="/assets/js/36.e8a1ac2f.js"><link rel="prefetch" href="/assets/js/37.e187a446.js"><link rel="prefetch" href="/assets/js/38.75296055.js"><link rel="prefetch" href="/assets/js/39.81ede555.js"><link rel="prefetch" href="/assets/js/4.eef6d0a5.js"><link rel="prefetch" href="/assets/js/40.92086d8f.js"><link rel="prefetch" href="/assets/js/41.77fe8ac2.js"><link rel="prefetch" href="/assets/js/42.ad77dce1.js"><link rel="prefetch" href="/assets/js/43.714ecbf7.js"><link rel="prefetch" href="/assets/js/44.bb453227.js"><link rel="prefetch" href="/assets/js/45.7bd9bdc7.js"><link rel="prefetch" href="/assets/js/5.ae17a9ef.js"><link rel="prefetch" href="/assets/js/6.41716a03.js"><link rel="prefetch" href="/assets/js/7.137caa55.js"><link rel="prefetch" href="/assets/js/8.f552d2b6.js"><link rel="prefetch" href="/assets/js/9.e9d1275f.js">
    <link rel="stylesheet" href="/assets/css/0.styles.be15e0e1.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">胖大人的日常记事</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">Home</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">Home</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/0001.html" class="sidebar-link">01 开篇词 | 使用 Webpack 实现前端工程化</a></li><li><a href="/0002.html" class="sidebar-link">02 什么是 Webpack</a></li><li><a href="/0003.html" class="sidebar-link">03 Webpack 开发环境搭建</a></li><li><a href="/0004.html" class="sidebar-link">04 使用 webpack-cli 体验零配置打包</a></li><li><a href="/0005.html" class="sidebar-link">05 基础概念和常见配置项介绍（一）</a></li><li><a href="/0006.html" class="sidebar-link">06 基础概念和常见配置项介绍（二）</a></li><li><a href="/0007.html" class="sidebar-link">07 Webpack 中的模块化开发</a></li><li><a href="/0008.html" class="sidebar-link">08 在 Webpack 中使用 Babel 转换 JavaScript 代码</a></li><li><a href="/0009.html" class="sidebar-link">09 Webpack 中使用 TypeScript 开发项目</a></li><li><a href="/0010.html" class="sidebar-link">10 Webpack 中样式相关的配置</a></li><li><a href="/0011.html" class="sidebar-link">11 Webpack 中使用 lint 工具来保证代码风格和质量</a></li><li><a href="/0012.html" class="sidebar-link">12 使用 Webpack 管理项目中的静态资源</a></li><li><a href="/0013.html" class="sidebar-link">13 Webpack 中打包 HTML 和多页面配置</a></li><li><a href="/0014.html" class="sidebar-link">14 Webpack Dev Server 本地开发服务</a></li><li><a href="/0015.html" class="sidebar-link">15 Webpack 中配置React和Vue开发环境</a></li><li><a href="/0016.html" class="sidebar-link">16 Webpack 环境相关配置及配置文件拆分</a></li><li><a href="/0017.html" class="sidebar-link">17 Webpack 优化之体积优化</a></li><li><a href="/0018.html" class="sidebar-link">18 Webpack 优化之增强缓存命中率</a></li><li><a href="/0019.html" class="sidebar-link">19 使用 Webpack 的 splitChunks 功能来拆分代码</a></li><li><a href="/0020.html" class="sidebar-link">20 Webpack 优化之速度优化</a></li><li><a href="/0021.html" class="sidebar-link">21 使用 Webpack 的 Tree-Shaking</a></li><li><a href="/0022.html" class="sidebar-link">22 为你准备了一份 Webpack 工程化最佳实践总结</a></li><li><a href="/0023.html" class="sidebar-link">23 怎么调试 Webpack？</a></li><li><a href="/0024.html" class="sidebar-link">24 Tapable —— Webpack 的核心模块</a></li><li><a href="/0025.html" class="sidebar-link">25 Webpack 的 Compiler 和 Compilation</a></li><li><a href="/0026.html" class="sidebar-link">26 Webpack 工作流程</a></li><li><a href="/0027.html" class="sidebar-link">27 从 Webpack 的产出代码来看 Webpack 是怎么执行的</a></li><li><a href="/0028.html" class="active sidebar-link">28 Webpack 的模块热替换做了什么？</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/0028.html#webpack-hmr-的流程" class="sidebar-link">Webpack HMR 的流程</a></li><li class="sidebar-sub-header"><a href="/0028.html#webpack-hmr-原理" class="sidebar-link">Webpack HMR 原理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/0028.html#module-hot-accept-函数" class="sidebar-link">module.hot.accept()函数</a></li><li class="sidebar-sub-header"><a href="/0028.html#module-hot-decline-函数" class="sidebar-link">module.hot.decline()函数</a></li><li class="sidebar-sub-header"><a href="/0028.html#module-hot-dispose-函数" class="sidebar-link">module.hot.dispose() 函数</a></li><li class="sidebar-sub-header"><a href="/0028.html#module-hot-status-获取-hmr-状态" class="sidebar-link">module.hot.status()获取 HMR 状态</a></li></ul></li><li class="sidebar-sub-header"><a href="/0028.html#总结" class="sidebar-link">总结</a></li></ul></li><li><a href="/0029.html" class="sidebar-link">29 实战：使用 PostCSS 打造移动适配方案</a></li><li><a href="/0030.html" class="sidebar-link">30 实战：手写一个 markdown-loader</a></li><li><a href="/0031.html" class="sidebar-link">31 实战：手写一个 prefetch-webpack-plugin 插件</a></li><li><a href="/0032.html" class="sidebar-link">32 实战：使用 Express 和中间件来实现 Webpack-dev-server</a></li><li><a href="/0033.html" class="sidebar-link">33 实战：使用 Stats 数据结构生成 Webpack 构建报告</a></li><li><a href="/0034.html" class="sidebar-link">34 实战：给 Webpack 项目添加 modern</a></li><li><a href="/0035.html" class="sidebar-link">35 Webpack 5.0</a></li><li><a href="/0036.html" class="sidebar-link">36 课程总结</a></li><li><a href="/0037.html" class="sidebar-link">37 附录：项目中常用的 loader</a></li><li><a href="/0038.html" class="sidebar-link">38 附录：项目中常用的插件</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p><img src="https://img.mukewang.com/5cd9648e0001230906400360.jpg" alt=""></p> <blockquote><p>不安于小成，然后足以成大器；不诱于小利，然后可以立远功。</p> <p>               ——方孝孺</p></blockquote> <p>Webpack 的模块热替换（HMR - Hot Module Replacement，又称为热替换、热更新等）是 Webpack 最令人兴奋的特性之一。在没有 HMR 之前，Web 前端开发者使用类似 LiveReload 这类工具配合浏览器插件监听文件变化，然后重新加载整个页面。当 Webpack 开启了 HMR 功能之后，我们的代码修改之时，Webpack 会重新打包，并且将修改后的代码发送到浏览器，浏览器替换老的代码，保证了页面状态不会丢失，在不刷新整个页面的前提下进行局部的更新。</p> <p>所谓保证页面状态，就是在不修改页面当前状态的情况下进行替换。举例来说，当我们打开一个页面，进行了很多步的操作（比如点击了页面的一个按钮），这时候页面弹出一个弹层，我们发现弹层的背景颜色不对，这时候我们可以直接修改代码，HMR 最终会在不刷新页面的前提下直接修改弹层的背景颜色，效果跟我们在 Chrome Devtools 内修改 CSS 样式一样。</p> <p>本篇文章先带领大家体验一下 HMR 的整个执行过程，然后深入到代码细节来看下 Webpack HMR 的实现原理。</p> <h2 id="webpack-hmr-的流程"><a href="#webpack-hmr-的流程" aria-hidden="true" class="header-anchor">#</a> Webpack HMR 的流程</h2> <p>首先我们需要创建一个 HMR 的项目，项目的文件列表如下：</p> <div class="language- extra-class"><pre class="language-text"><code>├── package.json
├── src
│   ├── index.html
│   ├── index.js
│   └── style.css
└── webpack.config.js
</code></pre></div><p>项目入口文件是<code>src/index.js</code>，其中引入了<code>src/style.css</code>，并且给 HTML 页面的<code>&lt;h1 id=&quot;app&quot;&gt;</code>的增加innerHTML内容，具体内容如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// index.js</span>
<span class="token keyword">import</span> <span class="token string">'./style.css'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> $node <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'app'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
$node<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">'Hi，Webpack HMR'</span><span class="token punctuation">;</span>
</code></pre></div><p>src/style.css的内容如下：</p> <div class="language-css extra-class"><pre class="language-css"><code><span class="token selector">body</span> <span class="token punctuation">{</span>
    <span class="token property">background</span><span class="token punctuation">:</span> greenyellow<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>src/index.html内容如下：</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token doctype">&lt;!DOCTYPE html&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>viewport<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>width=device-width, initial-scale=1.0<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>X-UA-Compatible<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>ie=edge<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Dev Server<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>app<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>在<code>webpack.config.js</code>内容中，增加<code>html-webpack-plugin</code>和 CSS 使用到的 loader，并且设置<code>devServer.hot=true</code>开启 <code>webpack-dev-server</code> 的 HMR 功能，最后在插件内配上<code>HotModuleReplacementPlugin</code>，这样 Webpack 的 HMR 功能就配置完毕了：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// webpack.config.js</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> webpack <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> HtmlWebPackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'html-webpack-plugin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    entry<span class="token punctuation">:</span> <span class="token string">'./src/index.js'</span><span class="token punctuation">,</span>
    devServer<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        contentBase<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        port<span class="token punctuation">:</span> <span class="token number">9000</span><span class="token punctuation">,</span>
        hot<span class="token punctuation">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    module<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        rules<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>test<span class="token punctuation">:</span> <span class="token regex">/\.css$/</span><span class="token punctuation">,</span> use<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>loader<span class="token punctuation">:</span> <span class="token string">'style-loader'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>loader<span class="token punctuation">:</span> <span class="token string">'css-loader'</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token keyword">new</span> <span class="token class-name">HtmlWebPackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            template<span class="token punctuation">:</span> <span class="token string">'src/index.html'</span><span class="token punctuation">,</span>
            filename<span class="token punctuation">:</span> <span class="token string">'index.html'</span><span class="token punctuation">,</span>
            inject<span class="token punctuation">:</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>HotModuleReplacementPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>配置完毕后，我们使用 npx 启动<code>webpack-dev-server --open</code>，这时候浏览器会自动打开我们的 HTML 首页：http://localhost:9000。我们修改index.js和style.css的内容，则浏览器的页面也进行变化，具体效果可以参考下面的 Gif 动图：</p> <p><img src="http://img.mukewang.com/5d0777790001565a07370446.gif" alt=""></p> <p>这时候 HMR 并不是真正的局部刷新，而是重新加载，详细请看下面的 Gif 动图。注意观察 Chrome DevTools 的 Network 面板请求是重新加载的，而不是增量加载：</p> <p><img src="http://img.mukewang.com/5d0777620001158503290372.gif" alt=""></p> <p>要解决这个问题，就需要我们在src/index.js增加一段代码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// index.js</span>
<span class="token comment">// 忽略之前的内容。。</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>module<span class="token punctuation">.</span>hot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 通知 webpack改模块接受 hmr</span>
    module<span class="token punctuation">.</span>hot<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'Cannot apply HMR update.'</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>增加这段代码之后，再来看 HMR 的局部更新效果就实现了，具体看下面的 Gif 动图：</p> <p><img src="http://img.mukewang.com/5d07774400017ac500140014.gif" alt=""></p> <p>接下来我们来看下 HMR 的具体流程是怎样的。</p> <h4 id="hmr-流程"><a href="#hmr-流程" aria-hidden="true" class="header-anchor">#</a> HMR 流程</h4> <p>现在我们启动 webpack-dev-server 之后，我们先来看下 Webpack 打包的 log ：</p> <p><img src="http://img.mukewang.com/5d07772c000102a008160314.png" alt=""></p> <p>从 log 中可以看出我们的entry打包出来了两个文件：<code>main.js</code>和<code>main.2cd06169aeecf9cddf61.hot-update.js</code>。这时候我们打开 Chrome 浏览器访问 http://localhost:9000，看下 Chrome 的 DevTools 的 Network 面板，查看页面的请求：</p> <p><img src="http://img.mukewang.com/5d0777130001f40802770136.png" alt=""></p> <p>通过观察发现，跟我们不使用 HMR 功能相比，我们页面请求由index.html和main.js两个请求（下图是没有 HMR 的正常请求），变成了 5 个请求。</p> <p><img src="http://img.mukewang.com/5d0776ea00010f6701320093.png" alt=""></p> <p>5 个请求的 URL 分别是：</p> <div class="language- extra-class"><pre class="language-text"><code>1. http://localhost:9000/
2. http://localhost:9000/main.js
3. http://localhost:9000/main.2cd06169aeecf9cddf61.hot-update.js
4. http://localhost:9000/sockjs-node/info?t=1556265072618
5. ws://localhost:9000/sockjs-node/670/rinymwto/websocket
</code></pre></div><p>5 个请求中<code>main.js</code>和<code>main.2cd06169aeecf9cddf61.hot-update.js</code>合起来是入口文件打包后的结果，这部分包含了 HMR 的 Runtime 和src/index.js的便以结果。其他 3 个请求中包含了一个 WebSocket 请求（ws://协议）。这是因为 HMR 是首先使用sockjs这个模块来创建一个 WebSocket 长连接来跟 Webpack 的打包服务通信的。</p> <p>这时候我们修改s<code>rc/index.js</code>的内容：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// src/index.js</span>
<span class="token operator">-</span> $node<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">'Webpack HMR'</span><span class="token punctuation">;</span> <span class="token comment">// 将 Webpack HMR 字符串修改为 Hi，Webpack HMR</span>
<span class="token operator">+</span> $node<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">'Hi，Webpack HMR'</span><span class="token punctuation">;</span>
</code></pre></div><p>在终端中，log 发生了变化：</p> <p><img src="http://img.mukewang.com/5d0776cf0001b8a708140313.png" alt=""></p> <p>生成了新的打包之后的文件，包括：<code>main.c243117d7cba3d4c4390.hot-update.js</code>和<code>c243117d7cba3d4c4390.hot-update.json</code>等。</p> <p>这时候我们观察 Chrome 的请求，首先是 WebSocket 的消息中收到了一条推送内容：</p> <p><img src="http://img.mukewang.com/5d0776ba00013e0003510134.png" alt=""></p> <p>注意这个data的值，就是咱们打包后的文件名 hash！然后 Chrome 发送了两个请求：</p> <div class="language- extra-class"><pre class="language-text"><code>http://localhost:9000/c243117d7cba3d4c4390.hot-update.json
http://localhost:9000/main.c243117d7cba3d4c4390.hot-update.js
</code></pre></div><p><img src="http://img.mukewang.com/5d0775fd0001595a06680177.png" alt=""></p> <p>这两个请求的就是更新下来的更新的代码，下面我们来看下 Chrome 一开始加载的main.2cd06169aeecf9cddf61.hot-update.js文件和后来请求过来的main.c243117d7cba3d4c4390.hot-update.js内容，比较下$node.innerHTML内容就是我们刚刚修改src/index.js的内容了：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// http://localhost:9000/main.2cd06169aeecf9cddf61.hot-update.js</span>
<span class="token function">webpackHotUpdate</span><span class="token punctuation">(</span><span class="token string">'main'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token string">'./src/index.js'</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> __webpack_exports__<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token string">'use strict'</span><span class="token punctuation">;</span>
        <span class="token function">eval</span><span class="token punctuation">(</span>
            <span class="token string">&quot;__webpack_require__.r(__webpack_exports__);\n/* harmony import */ var _style_css__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./style.css */ \&quot;./src/style.css\&quot;);\n/* harmony import */ var _style_css__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(_style_css__WEBPACK_IMPORTED_MODULE_0__);\n\nconst $node = document.getElementById('app');\n$node.innerHTML = 'Webpack HMR';\n\nif (true) {\n    // 通知 webpack改模块接受 hmr\n    module.hot.accept(err =&gt; {\n        if (err) {\n            console.error('Cannot apply HMR update.', err);\n        }\n    });\n}\n\n\n//# sourceURL=webpack:///./src/index.js?&quot;</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// http://localhost:9000/main.c243117d7cba3d4c4390.hot-update.js</span>
<span class="token function">webpackHotUpdate</span><span class="token punctuation">(</span><span class="token string">'main'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token string">'./src/index.js'</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> __webpack_exports__<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token string">'use strict'</span><span class="token punctuation">;</span>
        <span class="token function">eval</span><span class="token punctuation">(</span>
            <span class="token string">&quot;__webpack_require__.r(__webpack_exports__);\n/* harmony import */ var _style_css__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./style.css */ \&quot;./src/style.css\&quot;);\n/* harmony import */ var _style_css__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(_style_css__WEBPACK_IMPORTED_MODULE_0__);\n\nconst $node = document.getElementById('app');\n$node.innerHTML = 'Hi，Webpack HMR';\n\nif (true) {\n    // 通知 webpack改模块接受 hmr\n    module.hot.accept(err =&gt; {\n        if (err) {\n            console.error('Cannot apply HMR update.', err);\n        }\n    });\n}\n\n\n//# sourceURL=webpack:///./src/index.js?&quot;</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>通过上面的全流程观察，我们可以总结出来 Webpack HMR 的全流程图如下所示：</p> <p><img src="http://img.mukewang.com/5d0775600001e23210060750.jpg" alt=""></p> <p>上面的流程图展现了 HMR 的一个完整周期，整个周期分为两部分：启动阶段和文件监控更新流程。</p> <p>在启动阶段，Webpack 和 webpack-dev-server 进行交互。Webpack 和 webpack-dev-server 主要是通过 Express 的中间件 <a href="https://github.com/webpack/webpack-dev-middleware" target="_blank" rel="noopener noreferrer">webpack-dev-middleware<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>进行交互，这个阶段可以细分为以下几个步骤：</p> <p>webpack-dev-server 启动 Webpack 打包的 watch 模式，在这种模式下 Webpack 会监听文件的变化，一旦有文件发生变化，则会重新进行打包，watch 模式下 Webpack 打包的结果不会落盘（保存到硬盘上）；</p> <p>webpack-dev-server 通过 webpack-dev-middleware与 Webpack 进行交互，Webpack-dev-middleware 初始化会接收 Webpack 的 Compiler 对象，通过Compiler的钩子可以监听 Webpack 的打包过程；</p> <p>如果<code>devServer.watchContentBase=true</code>，则 webpack-dev-server 监听文件夹中静态文件的变化，发生变化则通知浏览器刷新页面重新请求新的文件；
打开浏览器之后，webpack-dev-server 会利用sockjs在浏览器和 Server 之间创建一个 WebSocket 长连接，这个长连接是浏览器和 webpack-dev-server 的通信桥梁，它们之间的通信内容主要是传递编译模块的文件信息（hash 值），这时候如果 Webpack 监控的文件发生了修改，<code>webpack/hot/dev-server</code>来实现 HMR 更新还是刷新页面。</p> <blockquote><p><em><strong>Tips：</strong></em></p> <p>webpack-dev-server 的 contentBase 可以理解为静态资源服务器的目录文件夹，启动 server 之后，可以通过网址+电脑中文件路径的方式访问到具体文件，这个文件跟 Webpack 打包出来的路径并不一样；
这里有两个文件变化的监控，第一步中 Webpack 监控整个依赖模块的文件变化，发生变化则重新出发 Webpack 编译；第三步中 webpack-dev-server 自己监控contentBase的文件变化，文件发生变化则通知浏览器刷新页面，这里是刷新页面并不是 HMR，这是因为contentBase内容是非 Webpack 打包的依赖文件。</p></blockquote> <p>WebSocket 需要服务端和浏览器端都有对应的创建连接代码（<code>new WebSocket</code>），<code>webpack-dev-server</code> 在浏览器中通过在 chunks 中插入<code>webpack-dev-server/client</code>这个文件来创建 WebSocket 通信。
到此启动阶段结束，当 Webpack 监控的文件发生变化之后，这时候就进入了文件监控更新流程，当 Webpack 监控的依赖图中的某个文件修改之后：</p> <p>Webpack 会重新编译文件，这时候我们在<code>webpack.config.js</code>中添加的插件 <code>HotModuleReplacementPlugin</code> 会生成两次编译之间差异文件列表（manifest）文件<code>[hash].hot-update.json</code>，这个 manifest JSON 文件包含了变化文件的 Update 内容，即<code>[id].[hash].hot-update.js</code>。webpack-dev-server 中的 webpack-dev-middler 会通过 Webpack 的Compiler钩子监听打包进程，然后通知 webpack-dev-server 使用 WebSocket 长连接推送编译之后的 hash 值；</p> <p>除了发送编译后 Hash 值之外，webpack-dev-server 还会通过长连接告诉浏览器当前的页面代码是<strong>invalid</strong>状态的，需要更新新的代码；</p> <p>浏览器拿到 Hash 之后，会首先发起一个 Ajax 请求 manifest 文件<code>[hash].hot-update.json</code>文件内容；</p> <p>manifest 列表文件内容拿到之后，会告诉 HMR 的 Runtime 请求那些变化的 JavaScript 文件，这时候会 Runtime 会按照清单列表发起 JSONP 请求，将两次编译的差异文件<code>[id].[hash].hot-update.js</code>获取下来，插到页面head标签的script中执行，最终完成了更新的全流程。</p> <p>WebSocket 消息的含义如下图所示：</p> <p><img src="http://img.mukewang.com/5d07743900010a2108730315.png" alt=""></p> <blockquote><p><em><strong>Tips：</strong></em></p> <p>这里的 Hash 值为 Compilation 的 hash 值，获取 manifest 和更新文件时用的是上一次的 hash 值；
manifest 和 update 文件名可以通过 Webpack 的output.hotUpdateMainFilename和output.hotUpdateChunkFilename来设置。</p></blockquote> <h4 id="小结一下"><a href="#小结一下" aria-hidden="true" class="header-anchor">#</a> 小结一下</h4> <p>整个过程虽然步骤比较多，而且涉及模块比较复杂，这里先小结下：</p> <ul><li>webpack-dev-server：启动一个 Express Server，整合 webpack-dev-middleware 中间件、WebSocket 长连接、proxy、静态资源服务器等功能；</li> <li>webpack-dev-middleware：跟 Webpack 进行交互，通过Compiler的 Hook 来监控打包流程，保证文件修改后打包结束后请求新的文件，上线一个内存型的文件系统，文件直接从内存读取可以提升 webpack-dev-server 的速度。</li> <li>HotModuleReplacementPlugin：插件是用来生成 HMR 的文件清单列表和差异文件的：</li> <li>manifest 文件：JSON 文件，文件名格式为<code>[hash].hot-update.json</code>，包含所有需要更新的文件信息；</li> <li>update 文件：需要更新的 JavaScript 文件，文件名格式为<code>[id].[hash].hot-update.js</code>，包含 HMR 的差异化执行代码。</li></ul> <h2 id="webpack-hmr-原理"><a href="#webpack-hmr-原理" aria-hidden="true" class="header-anchor">#</a> Webpack HMR 原理</h2> <p>HMR 的全流程我们已经梳理清楚了，下面就是 HMR 实现的技术细节了，要理解 HMR 的技术细节，只需要回答下面 4 个问题即可：</p> <ol><li>webpack-dev-middleware 是怎么让 Webpack 打包出来的文件存入内存的？</li></ol> <p>在 webpack-dev-middleware 中，使用了memory-fs这个内存文件系统模块，然后将 Webpack 的Compiler对象的Compiler.outputFileSystem替换掉，Compiler.outputFileSystem就是输出打包结果文件的：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// webpack-dev-middleware/lib/fs.js</span>
<span class="token keyword">const</span> MemoryFileSystem <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'memory-fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token function">setFs</span><span class="token punctuation">(</span><span class="token parameter">context<span class="token punctuation">,</span> compiler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//.. 忽略</span>
        fileSystem <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MemoryFileSystem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        compiler<span class="token punctuation">.</span>outputFileSystem <span class="token operator">=</span> fileSystem<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><ol start="2"><li>HotModuleReplacementPlugin 怎么计算两次编译差量文件的？</li></ol> <p>这里 Webpack wiki 中有一张比较形象的图：
<img src="http://img.mukewang.com/5d07740a0001892e08340616.jpg" alt=""></p> <p>上图中，右边的 moduleID 为4和9的模块发生了变化，那么依赖两个模块的 4 个 Chunk 文件就需要更新，这 4 个 chunks 被放入了manifestJSON 文件中：</p> <p><code>moduleID=9</code>模块修改后：引入了新的依赖12，所以 chunk=3生成了包含9和12的 update 文件；</p> <p><code>moduleID=4</code>模块修改后：</p> <p>去掉了 <code>chunk=4</code>的依赖，所以<code>chunk=4</code>中的10和11没有其他的模块使用，所以删除掉；</p> <p>依赖<code>moduleID=4</code>模块的<code>chunk=1</code>需要更新4更新的内容；</p> <p>最后是入口文件<code>entry=0</code>文件依赖<code>chunks=[1,3,4]</code>需要更新。</p> <blockquote><p><em><strong>Tips：</strong></em> 每个模块（module）都可以通过它的<code>parents</code>和<code>children</code>属性找到自己被谁依赖和依赖谁。</p></blockquote> <ol start="3"><li>HMR Runtime 是根据怎样的规则去拉取新代码的？
HMR Runtime 指的是HotModuleReplacementPlugin插件中，通过<code>Compilation.mainTemplate</code>的bootstrap钩子注入的<code>lib/HotModuleReplacement.runtime.js</code>文件：</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// webpack 4.30.0</span>
<span class="token comment">// lib/HotModuleReplacementPlugin.js</span>
<span class="token keyword">const</span> hotInitCode <span class="token operator">=</span> Template<span class="token punctuation">.</span><span class="token function">getFunctionContent</span><span class="token punctuation">(</span>
    <span class="token comment">// lib/HotModuleReplacement.runtime.js内容</span>
    <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./HotModuleReplacement.runtime'</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// hook 钩子注入</span>
mainTemplate<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>bootstrap<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'HotModuleReplacementPlugin'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">source<span class="token punctuation">,</span> chunk<span class="token punctuation">,</span> hash</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    source <span class="token operator">=</span> mainTemplate<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">hotBootstrap</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> chunk<span class="token punctuation">,</span> hash<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> Template<span class="token punctuation">.</span><span class="token function">asString</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
        source<span class="token punctuation">,</span>
        <span class="token string">''</span><span class="token punctuation">,</span>
        hotInitCode
            <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/\$require\$/g</span><span class="token punctuation">,</span> mainTemplate<span class="token punctuation">.</span>requireFn<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/\$hash\$/g</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>hash<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/\$requestTimeout\$/g</span><span class="token punctuation">,</span> requestTimeout<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>
                <span class="token regex">/\/\*foreachInstalledChunks\*\//g</span><span class="token punctuation">,</span>
                <span class="token function">needChunkLoadingCode</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span>
                    <span class="token operator">?</span> <span class="token string">'for(var chunkId in installedChunks)'</span>
                    <span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">var chunkId = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>chunk<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">;</span><span class="token template-punctuation string">`</span></span>
            <span class="token punctuation">)</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>这个 Runtime 中会调用mainTemplate根据不同环境注入的runtime.js。在浏览器环境下，注入的是<code>lib/web/JsonpMainTemplate.runtime.js</code>，这里有 2 个跟更新有关的函数，分别是：</p> <ul><li>hotDownloadManifest：发起 Ajax 请求 mainifest JSON 文件；</li> <li>hotDownloadUpdateChunk：创建 JSONP 请求 update 文件。
详细代码可以参见<code>lib/web/JsonpMainTemplate.runtime.js</code>内容，其他 Node.js 执行环境、WebWorker 执行环境类似。</li></ul> <ol start="4"><li>如何让自己的代码支持 HMR？
我们在学习 DOM 事件的时候知道，DOM 事件会顺着 DOM 树进行冒泡。如果当前的节点不停止冒泡，则事件会往其父节点继续冒泡，一直到根节点。在 Webpack 的 HMR 处理上，也是有这个冒泡过程的。Webpack 的模块实际也有一个 module 树，module 树的根节点就是入口文件（entry），当我们一个模块代码发生了更改，就需要执行 update 事件，如果当前模块处理不了这个事件，即不知道怎么实现 HMR，那么会冒泡到父依赖节点，直到有模块可以处理 HMR 更新代码，如果到了根节点（entry）都没有处理 update 事件，就会刷新页面。</li></ol> <p>因为我们的代码究竟能不能实现 HMR 只有编写者知道，比如我们一个 Vue 应用，修改了 Vue 组件的template和state肯定是不同的处理方式，所以不能一概而论地都给所有的 JavaScript 模块添加<code>module.hot.accept()</code>，要视情况而定。</p> <p>幸运的是大多数框架，像 React、Vue、Angular 都有自己的 HMR 工具。这些工具有的是通过 loader 的方式来实现，有的是通过 Babel 插件方式来实现的。另外要实现 Less、Sass、CSS 文件的热加载，我们可以直接使用 style-loader 来完成（生产环境打包模式下不建议使用），比如在开发模式下对于 CSS 的加载可以配置如下的 loader：</p> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    module<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        rules<span class="token punctuation">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{</span>
                test<span class="token punctuation">:</span> <span class="token regex">/\.css$/</span><span class="token punctuation">,</span>
                use<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'style-loader'</span><span class="token punctuation">,</span> <span class="token string">'css-loader'</span><span class="token punctuation">]</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>接下来介绍下如果要自己编写 HMR 的代码，那么需要用到的几个 Webpack 的扩展函数方法：</p> <ul><li><strong>module.hot.accept()</strong></li> <li><strong>module.hot.decline()</strong></li> <li><strong>module.hot.dispose()</strong></li> <li><strong>module.hot.status()</strong></li> <li><strong>module.hot.apply()</strong></li></ul> <h3 id="module-hot-accept-函数"><a href="#module-hot-accept-函数" aria-hidden="true" class="header-anchor">#</a> module.hot.accept()函数</h3> <p>**module.accept()**有两种使用方式，第一种是在使用的时候，声明对应依赖模块，当声明的依赖模块的更新后才会执行对应的回调，这种方式的使用方式如下：</p> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span>hot<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span>
    dependencies<span class="token punctuation">,</span> <span class="token comment">// 可以是一个字符串或字符串数组</span>
    callback <span class="token comment">// 用于在模块更新后触发的函数</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>这里的callback会拿到更新的依赖模块，即<code>callback(updatedDependencies)</code>。</p> <p>accept的第二种用法是自身更新：</p> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span>hot<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span>
    errorHandler <span class="token comment">// 在计算新版本时处理错误的函数</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>在这种用法中，当前模块所有依赖的模块代码会被更新，而且这种更新不会冒泡到父级模块中去。如果此模块没有导出（export）的情况下有用（这是因为没有导出，所以也就没有父级调用它）。</p> <h3 id="module-hot-decline-函数"><a href="#module-hot-decline-函数" aria-hidden="true" class="header-anchor">#</a> module.hot.decline()函数</h3> <p>**module.hot.decline()**函数接受一个模块依赖列表，表示拒绝这些依赖模块的更新：</p> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span>hot<span class="token punctuation">.</span><span class="token function">decline</span><span class="token punctuation">(</span>
    dependencies <span class="token comment">// 可以是一个字符串或字符串数组</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>这时候我们在父模块可以获取到错误代码decline。通常这种情况下，我们没法处理 HMR 模块，只能重新加载页面。</p> <h3 id="module-hot-dispose-函数"><a href="#module-hot-dispose-函数" aria-hidden="true" class="header-anchor">#</a> module.hot.dispose() 函数</h3> <p>**module.hot.dispose()**是给当前模块代码添加一个处理函数，当前模块代码被替换时会执行对应的处理函数回调。被添加的函数应该用于移除你声明或创建的任何持久资源。如果要将状态传入到更新过的模块，请添加给定 data 参数。更新后，此对象在更新之后可通过 <code>module.hot.data</code> 调用：</p> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span>hot<span class="token punctuation">.</span><span class="token function">dispose</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 清理并将 data 传递到更新后的模块……</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>举个例子说明，我们有个模块中存在一个全局变量globalId。模块更新的时候，我们希望重新定义这个变量，或者将这个变量放到 data 中，下次可以通过<code>module.hot.data</code>进行访问，那么我们可以写如下代码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>module<span class="token punctuation">.</span>hot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    module<span class="token punctuation">.</span>hot<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// dispose handler</span>
    module<span class="token punctuation">.</span>hot<span class="token punctuation">.</span><span class="token function">dispose</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 使用，这时候 globalId 是更新之前的，而不是更新之后的变量值</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>globalId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 重新定义</span>
        globalId <span class="token operator">=</span> <span class="token number">999</span><span class="token punctuation">;</span>
        <span class="token comment">// 放到 data</span>
        data<span class="token punctuation">.</span>globalId <span class="token operator">=</span> globalId<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p><em><strong>Tips：</strong></em> dispose是addDisposeHandler的 alias，所以<code>module.hot.dispose</code>效果等同于<code>module.hot.addDisposeHandler()</code>，而要移除这个回调，可以使用<code>module.hot.removeDisposeHandler(callback)</code>。</p></blockquote> <h3 id="module-hot-status-获取-hmr-状态"><a href="#module-hot-status-获取-hmr-状态" aria-hidden="true" class="header-anchor">#</a> module.hot.status()获取 HMR 状态</h3> <p>在 HMR 中，我们可以使用module.hot.status()获取 HMR 的状态，状态有以下几种：</p> <ul><li><strong>idle</strong>：当前 HMR 处于空闲状态，可以调用 <code>module.hot.check</code>方法检测更新情况，调用<code>module.hot.check</code>后状态为 check；</li> <li><strong>check</strong>： HMR 正在检查模块更新，如果没有模块更新，那么重新回到 idle 状态。如果有更新那么会依次经过 prepare、dispose、apply 然后重新回到 idle 状态；</li> <li><strong>watch和watch-delay</strong>：watch表明 HMR 当前处于监听模式，可以自动接收到更新。如果接受到更新，那么就会进入 watch-delay 模式，然后等待机会开始更新操作。如果开始更新，那么会依次经过 prepare、dispose、apply状态。如果在更新的时候又监听到文件更新，那么重新回到 watch 或者 watch-delay状态；</li> <li><strong>prepare</strong>：表明 HMR 在准备更新。比如正在下载 Webpack 更新后的一些资源用于更新；</li> <li><strong>ready</strong>： 可以开始更新了，需要手动调用 apply 方法去继续更新操作；</li> <li><strong>dispose</strong>： HMR 在调用模块自己的 dispose 方法，并开始更新后的模块替换操作；</li> <li><strong>apply</strong>： HMR 在调用被替换后（dispose）的模块的父级模块的 accept 方法，当然模块自己必须能够被 dispose；</li> <li><strong>abort</strong>： 更新无法被进一步 apply，但是文件处于更新之前的一致状态；</li> <li><strong>fail</strong>： 在更新过程中抛出了异常，当前的文件状态处于不一致状态，系统需要重启。</li></ul> <p>我们还可以通过注入status的监听回调对 HMR 的status进行监听：</p> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span>hot<span class="token punctuation">.</span><span class="token function">addStatusHandler</span><span class="token punctuation">(</span><span class="token parameter">status</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 响应当前状态……</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 移除监听</span>
module<span class="token punctuation">.</span>hot<span class="token punctuation">.</span><span class="token function">removeStatusHandler</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span><span class="token function">hot</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token punctuation">)</span>函数
module<span class="token punctuation">.</span><span class="token function">hot</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token punctuation">)</span>函数用于主动触发更新流程，调用方式如下：

module<span class="token punctuation">.</span><span class="token function">hot</span>
    <span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">outdatedModules</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 过期的模块……</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">error</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 捕获错误</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>其中 options 的参数有：</p> <ul><li><strong>ignoreUnaccepted</strong>：调用 accept 时没有指定的模块。如果 accpet 没有参数，接受任何模块更新；</li> <li><strong>ignoreDeclined</strong> ：调用 decline 明确指定不需要检查的模块；</li> <li><strong>ignoreErrored</strong> ：忽略在调用accept` 时抛出的错误；</li> <li><strong>onDeclined</strong>：接收 decline 指定的模块的回调函数；</li> <li><strong>onUnaccepted</strong>：接收 accept 中没有指定的模块的回调；</li> <li><strong>onAccepted</strong>：接收 accept 中指定的模块的回调；</li> <li><strong>onDisposed</strong>：接收被 dispose 的模块的回调；</li> <li><strong>onErrored</strong>：接收出错的模块回调。</li></ul> <p>每一个函数接受到的参数为如下类型：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
    type<span class="token punctuation">:</span> <span class="token string">&quot;self-declined&quot;</span> <span class="token operator">|</span> <span class="token string">&quot;declined&quot;</span> <span class="token operator">|</span>
        <span class="token string">&quot;unaccepted&quot;</span> <span class="token operator">|</span> <span class="token string">&quot;accepted&quot;</span> <span class="token operator">|</span>
        <span class="token string">&quot;disposed&quot;</span> <span class="token operator">|</span> <span class="token string">&quot;accept-errored&quot;</span> <span class="token operator">|</span>
        <span class="token string">&quot;self-accept-errored&quot;</span> <span class="token operator">|</span> <span class="token string">&quot;self-accept-error-handler-errored&quot;</span><span class="token punctuation">,</span>
    moduleId<span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
    <span class="token comment">// The module in question.</span>
    dependencyId<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
    <span class="token comment">// For errors: the module id owning the accept handler.</span>
    chain<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token comment">// For declined/accepted/unaccepted: the chain from where the update was propagated.</span>
    <span class="token comment">// 这个 chain 表示更新冒泡的顺序</span>
    parentId<span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
    <span class="token comment">// For declined: the module id of the declining parent</span>
    outdatedModules<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token comment">// For accepted: the modules that are outdated and will be disposed</span>
    outdatedDependencies<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// For accepted: The location of accept handlers that will handle the update</span>
    <span class="token number">5</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    error<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">// For errors: the thrown error</span>
    originalError<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span>
    <span class="token comment">// For self-accept-error-handler-errored:</span>
    <span class="token comment">// the error thrown by the module before the error handler tried to handle it.</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="总结"><a href="#总结" aria-hidden="true" class="header-anchor">#</a> 总结</h2> <p>本文主要讲解 Webpack 的 Hot Module Replacement 流程和实现原理。先从实际项目复习了 HMR 的用法和体验了 HMR 的流程，然后详细讲解了 HMR 的整个流程中各个模块做的事情，最后在原理上通过解答 3 个问题来加深对 HMR 原理的理解。webpack-dev-server 虽然可以直接来启动 HMR，但是真正核心的是 webpack-dev-middleware。webpack-dev-server 除了这个中间件之外主要功能就是个静态服务器，而后面实战部分我会使用 <code>Express</code>、<code>webpack-dev-middleware</code> 自己来实现 <strong>「webpack-dev-server」</strong>，通过实战加深 HMR 原理 和 webpack-dev-server 功能理解。</p> <p><strong>本小节 Webpack 相关面试题：</strong></p> <ol><li>怎么配置 Webpack 的热替换更新？</li> <li>Webpack 热替换是怎么实现的？</li></ol></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">9/14/2019, 2:07:17 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/0027.html" class="prev">27 从 Webpack 的产出代码来看 Webpack 是怎么执行的</a></span> <span class="next"><a href="/0029.html">29 实战：使用 PostCSS 打造移动适配方案</a>→
    </span></p></div> </main></div><div class="global-ui"><SWUpdatePopup></SWUpdatePopup></div></div>
    <script src="/assets/js/app.745025a3.js" defer></script><script src="/assets/js/2.d6c01b35.js" defer></script><script src="/assets/js/33.d17510e5.js" defer></script>
  </body>
</html>

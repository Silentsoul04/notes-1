<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>胖大人的日常记事</title>
    <meta name="description" content="Just playing around">
    <link rel="icon" href="logo.png">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#3eaf7c">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <link rel="apple-touch-icon" href="logo.png">
  <link rel="mask-icon" href="logo.svg" color="#3eaf7c">
  <meta name="msapplication-TileImage" content="logo_144*144.png">
  <meta name="msapplication-TileColor" content="#000000">
    
    <link rel="preload" href="/assets/css/0.styles.be15e0e1.css" as="style"><link rel="preload" href="/assets/js/app.745025a3.js" as="script"><link rel="preload" href="/assets/js/2.d6c01b35.js" as="script"><link rel="preload" href="/assets/js/29.59b2df76.js" as="script"><link rel="prefetch" href="/assets/js/10.b15f60e2.js"><link rel="prefetch" href="/assets/js/11.535b2ad8.js"><link rel="prefetch" href="/assets/js/12.46ffc8b5.js"><link rel="prefetch" href="/assets/js/13.4b23805e.js"><link rel="prefetch" href="/assets/js/14.6e6cf41b.js"><link rel="prefetch" href="/assets/js/15.47414791.js"><link rel="prefetch" href="/assets/js/16.ecc1171d.js"><link rel="prefetch" href="/assets/js/17.c118399e.js"><link rel="prefetch" href="/assets/js/18.eea3e35b.js"><link rel="prefetch" href="/assets/js/19.b12d698f.js"><link rel="prefetch" href="/assets/js/20.a584b4e7.js"><link rel="prefetch" href="/assets/js/21.3e0bdf10.js"><link rel="prefetch" href="/assets/js/22.276850a1.js"><link rel="prefetch" href="/assets/js/23.b3efca3c.js"><link rel="prefetch" href="/assets/js/24.c7601923.js"><link rel="prefetch" href="/assets/js/25.39614ac1.js"><link rel="prefetch" href="/assets/js/26.60483ab2.js"><link rel="prefetch" href="/assets/js/27.bfb61d9d.js"><link rel="prefetch" href="/assets/js/28.7dadd6bc.js"><link rel="prefetch" href="/assets/js/3.ded4051d.js"><link rel="prefetch" href="/assets/js/30.a7a4f806.js"><link rel="prefetch" href="/assets/js/31.48156b6a.js"><link rel="prefetch" href="/assets/js/32.e7ff8ffb.js"><link rel="prefetch" href="/assets/js/33.d17510e5.js"><link rel="prefetch" href="/assets/js/34.f00dca94.js"><link rel="prefetch" href="/assets/js/35.303cbcea.js"><link rel="prefetch" href="/assets/js/36.e8a1ac2f.js"><link rel="prefetch" href="/assets/js/37.e187a446.js"><link rel="prefetch" href="/assets/js/38.75296055.js"><link rel="prefetch" href="/assets/js/39.81ede555.js"><link rel="prefetch" href="/assets/js/4.eef6d0a5.js"><link rel="prefetch" href="/assets/js/40.92086d8f.js"><link rel="prefetch" href="/assets/js/41.77fe8ac2.js"><link rel="prefetch" href="/assets/js/42.ad77dce1.js"><link rel="prefetch" href="/assets/js/43.714ecbf7.js"><link rel="prefetch" href="/assets/js/44.bb453227.js"><link rel="prefetch" href="/assets/js/45.7bd9bdc7.js"><link rel="prefetch" href="/assets/js/5.ae17a9ef.js"><link rel="prefetch" href="/assets/js/6.41716a03.js"><link rel="prefetch" href="/assets/js/7.137caa55.js"><link rel="prefetch" href="/assets/js/8.f552d2b6.js"><link rel="prefetch" href="/assets/js/9.e9d1275f.js">
    <link rel="stylesheet" href="/assets/css/0.styles.be15e0e1.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">胖大人的日常记事</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">Home</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">Home</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/0001.html" class="sidebar-link">01 开篇词 | 使用 Webpack 实现前端工程化</a></li><li><a href="/0002.html" class="sidebar-link">02 什么是 Webpack</a></li><li><a href="/0003.html" class="sidebar-link">03 Webpack 开发环境搭建</a></li><li><a href="/0004.html" class="sidebar-link">04 使用 webpack-cli 体验零配置打包</a></li><li><a href="/0005.html" class="sidebar-link">05 基础概念和常见配置项介绍（一）</a></li><li><a href="/0006.html" class="sidebar-link">06 基础概念和常见配置项介绍（二）</a></li><li><a href="/0007.html" class="sidebar-link">07 Webpack 中的模块化开发</a></li><li><a href="/0008.html" class="sidebar-link">08 在 Webpack 中使用 Babel 转换 JavaScript 代码</a></li><li><a href="/0009.html" class="sidebar-link">09 Webpack 中使用 TypeScript 开发项目</a></li><li><a href="/0010.html" class="sidebar-link">10 Webpack 中样式相关的配置</a></li><li><a href="/0011.html" class="sidebar-link">11 Webpack 中使用 lint 工具来保证代码风格和质量</a></li><li><a href="/0012.html" class="sidebar-link">12 使用 Webpack 管理项目中的静态资源</a></li><li><a href="/0013.html" class="sidebar-link">13 Webpack 中打包 HTML 和多页面配置</a></li><li><a href="/0014.html" class="sidebar-link">14 Webpack Dev Server 本地开发服务</a></li><li><a href="/0015.html" class="sidebar-link">15 Webpack 中配置React和Vue开发环境</a></li><li><a href="/0016.html" class="sidebar-link">16 Webpack 环境相关配置及配置文件拆分</a></li><li><a href="/0017.html" class="sidebar-link">17 Webpack 优化之体积优化</a></li><li><a href="/0018.html" class="sidebar-link">18 Webpack 优化之增强缓存命中率</a></li><li><a href="/0019.html" class="sidebar-link">19 使用 Webpack 的 splitChunks 功能来拆分代码</a></li><li><a href="/0020.html" class="sidebar-link">20 Webpack 优化之速度优化</a></li><li><a href="/0021.html" class="sidebar-link">21 使用 Webpack 的 Tree-Shaking</a></li><li><a href="/0022.html" class="sidebar-link">22 为你准备了一份 Webpack 工程化最佳实践总结</a></li><li><a href="/0023.html" class="sidebar-link">23 怎么调试 Webpack？</a></li><li><a href="/0024.html" class="active sidebar-link">24 Tapable —— Webpack 的核心模块</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/0024.html#事件监听和发射器" class="sidebar-link">事件监听和发射器</a></li><li class="sidebar-sub-header"><a href="/0024.html#tapable-中-hook-的类型" class="sidebar-link">Tapable 中 Hook 的类型</a></li><li class="sidebar-sub-header"><a href="/0024.html#tapable-的原理解析" class="sidebar-link">Tapable 的原理解析</a></li><li class="sidebar-sub-header"><a href="/0024.html#总结" class="sidebar-link">总结</a></li></ul></li><li><a href="/0025.html" class="sidebar-link">25 Webpack 的 Compiler 和 Compilation</a></li><li><a href="/0026.html" class="sidebar-link">26 Webpack 工作流程</a></li><li><a href="/0027.html" class="sidebar-link">27 从 Webpack 的产出代码来看 Webpack 是怎么执行的</a></li><li><a href="/0028.html" class="sidebar-link">28 Webpack 的模块热替换做了什么？</a></li><li><a href="/0029.html" class="sidebar-link">29 实战：使用 PostCSS 打造移动适配方案</a></li><li><a href="/0030.html" class="sidebar-link">30 实战：手写一个 markdown-loader</a></li><li><a href="/0031.html" class="sidebar-link">31 实战：手写一个 prefetch-webpack-plugin 插件</a></li><li><a href="/0032.html" class="sidebar-link">32 实战：使用 Express 和中间件来实现 Webpack-dev-server</a></li><li><a href="/0033.html" class="sidebar-link">33 实战：使用 Stats 数据结构生成 Webpack 构建报告</a></li><li><a href="/0034.html" class="sidebar-link">34 实战：给 Webpack 项目添加 modern</a></li><li><a href="/0035.html" class="sidebar-link">35 Webpack 5.0</a></li><li><a href="/0036.html" class="sidebar-link">36 课程总结</a></li><li><a href="/0037.html" class="sidebar-link">37 附录：项目中常用的 loader</a></li><li><a href="/0038.html" class="sidebar-link">38 附录：项目中常用的插件</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p><img src="https://img1.mukewang.com/5cd9645100016fb206400360.jpg" alt=""></p> <blockquote><p>立志是事业的大门，工作是登门入室的的旅途。</p> <p>               ——巴斯德</p></blockquote> <p>Webpack 工程相当庞大，但 Webpack 本质上是一种事件流机制。通过事件流将各种插件串联起来，最终完成 Webpack 的全流程，而实现事件流机制的核心是今天要讲的Tapable 模块。Webpack 负责编译的 Compiler 和创建 Bundle 的 Compilation 都是继承自 Tapable。所以在讲 Webpack 工作流程之前，我们需要先掌握 Tapable。</p> <h2 id="事件监听和发射器"><a href="#事件监听和发射器" aria-hidden="true" class="header-anchor">#</a> 事件监听和发射器</h2> <p>我们都知道 Node.js 特点提到事件驱动，这是因为 Node.js 本身利用 JavaScript 的语言特点实现了自定义的事件回调。Node.js 内部一个事件发射器 <code>EventEmitter</code>，通过这个类，可以进行事件监听与发射。这个也是 Node.js 的核心模块，很多 Node.js 内部模块都是继承自它，或者引用了它。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> EventEmitter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'events'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>EventEmitter<span class="token punctuation">;</span>
<span class="token keyword">const</span> event <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventEmitter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
event<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'event_name'</span><span class="token punctuation">,</span> <span class="token parameter">arg</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'event_name fire'</span><span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    event<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'event_name'</span><span class="token punctuation">,</span> <span class="token string">'hello world'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>上面代码就是事件发射器的用法。</p> <p>Webpack 核心库 Tapable 的原理和 EventEmitter 类似，但是功能更强大，包括多种类型，通过事件的注册和监听，触发 Webpack 生命周期中的函数方法。在Webpack 中，tapable 都是放到对象的hooks上，所以我们叫它们钩子。翻阅 Webpack 的源码时，会发现很多类似下面的代码：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// webpack 4.29.6</span>
<span class="token comment">// lib/compiler</span>
<span class="token keyword">class</span> <span class="token class-name">Compiler</span> <span class="token keyword">extends</span> <span class="token class-name">Tapable</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>hooks <span class="token operator">=</span> <span class="token punctuation">{</span>
            shouldEmit<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">SyncBailHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'compilation'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            done<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">AsyncSeriesHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'stats'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            additionalPass<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">AsyncSeriesHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            beforeRun<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">AsyncSeriesHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'compiler'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            run<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">AsyncSeriesHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'compiler'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            emit<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">AsyncSeriesHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'compilation'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            afterEmit<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">AsyncSeriesHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'compilation'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

            thisCompilation<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'compilation'</span><span class="token punctuation">,</span> <span class="token string">'params'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            compilation<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'compilation'</span><span class="token punctuation">,</span> <span class="token string">'params'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            normalModuleFactory<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'normalModuleFactory'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            contextModuleFactory<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'contextModulefactory'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

            beforeCompile<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">AsyncSeriesHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'params'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            compile<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'params'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            make<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">AsyncParallelHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'compilation'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            afterCompile<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">AsyncSeriesHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'compilation'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

            watchRun<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">AsyncSeriesHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'compiler'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            failed<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'error'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            invalid<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'filename'</span><span class="token punctuation">,</span> <span class="token string">'changeTime'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            watchClose<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

            environment<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            afterEnvironment<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            afterPlugins<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'compiler'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            entryOption<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">SyncBailHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'context'</span><span class="token punctuation">,</span> <span class="token string">'entry'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这些代码就是一个类或者函数完整生命周期需要 <strong>「走过的路」</strong> 。所有的 Webpack 代码，虽然代码量很大，但是从hook找生命周期事件点，然后通过 Hook 名称，基本就可以猜出大概流程。</p> <h2 id="tapable-中-hook-的类型"><a href="#tapable-中-hook-的类型" aria-hidden="true" class="header-anchor">#</a> Tapable 中 Hook 的类型</h2> <p>在Tapable 的文档中显示了，Tapable 分为以下类型：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// tapable 1.1.1</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>
    SyncHook<span class="token punctuation">,</span>
    SyncBailHook<span class="token punctuation">,</span>
    SyncWaterfallHook<span class="token punctuation">,</span>
    SyncLoopHook<span class="token punctuation">,</span>
    AsyncParallelHook<span class="token punctuation">,</span>
    AsyncParallelBailHook<span class="token punctuation">,</span>
    AsyncSeriesHook<span class="token punctuation">,</span>
    AsyncSeriesBailHook<span class="token punctuation">,</span>
    AsyncSeriesWaterfallHook
<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'tapable'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Hook 类型可以分为<strong>同步（Sync）<strong>和异步 <strong>（Async）</strong> ，异步又分为</strong>并行和串行</strong>：</p> <p><img src="http://img.mukewang.com/5d076a520001811512870187.png" alt=""></p> <p>根据使用方式来分，又可以分为<code>Basic</code>、<code>Waterfal</code>、<code>Bail</code>和<code>Loop</code>四类，每类 Hook 都有自己的使用要点：</p> <table><thead><tr><th>类型</th> <th>使用要点</th></tr></thead> <tbody><tr><td>Basic</td> <td>基础类型，不关心监听函数的返回值，不根据返回值做事情</td></tr> <tr><td>Bail</td> <td>保险式，只要监听函数中有返回值（不为undefined），则跳过之后的监听函数</td></tr> <tr><td>Waterfal</td> <td>瀑布式，上一步的返回值继续交给下一步处理和使用</td></tr> <tr><td>Loop</td> <td>循环类型，如果该监听函数返回 true 则这个监听函数会反复执行，如果返回 undefined 则退出循环</td></tr></tbody></table> <h4 id="basic-类型-hook"><a href="#basic-类型-hook" aria-hidden="true" class="header-anchor">#</a> Basic  类型 Hook</h4> <p>基础类型包括<code>SyncHook</code>、<code>AsyncParallelHook</code>和<code>AsyncSeriesHook</code>，这类 Hook 不关心函数的返回值，会一直执行到底。下面以SyncHook为例来说明下：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token punctuation">{</span>SyncHook<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'tapable'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 所有的构造函数都接收一个可选的参数，这个参数是一个参数名的字符串数组</span>
<span class="token comment">// 1. 这里array的字符串随便填写，但是array的长度必须与实际要接受参数个数保持一致；</span>
<span class="token comment">// 2. 如果回调不接受参数，可以传入空数组。</span>
<span class="token comment">// 后面类型都是这个规则，不再做过多说明</span>
<span class="token keyword">const</span> hook <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 添加监听</span>
hook<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">arg0<span class="token punctuation">,</span> arg1</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// tap 的第一个参数是用来标识`call`传入的参数</span>
    <span class="token comment">// 因为new的时候只的array长度为1</span>
    <span class="token comment">// 所以这里只得到了`call`传入的第一个参数，即Webpack</span>
    <span class="token comment">// arg1 为 undefined</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arg0<span class="token punctuation">,</span> arg1<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token string">'1'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
hook<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">,</span> <span class="token parameter">arg0</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arg0<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
hook<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'3'</span><span class="token punctuation">,</span> <span class="token parameter">arg0</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arg0<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 传入参数，触发监听的函数回调</span>
<span class="token comment">// 这里传入两个参数，但是实际回调函数只得到一个</span>
<span class="token function">hook</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'Webpack'</span><span class="token punctuation">,</span> <span class="token string">'Tapable'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 执行结果:</span>
<span class="token comment">/*
Webpack undefined 1 // 传入的参数需要和new实例的时候保持一致，否则获取不到多传的参数
Webpack 2
Webpack 3
*/</span>
</code></pre></div><p>通过上面的代码可以得出结论：</p> <ul><li>在实例化SyncHook传入的数组参数实际是只用了长度，跟实际内容没有关系；</li> <li>执行call时，入参个数跟实例化时数组长度相关；</li> <li>回调栈是按照「先入先出」顺序执行的（这里叫回调队列更合适，队列是先入先出）；</li> <li>功能跟 EventEmitter 类似。</li></ul> <p>详细的流程图如下：</p> <p><img src="http://img.mukewang.com/5d076a8b000157ca02800491.png" alt=""></p> <h4 id="bail-类型-hook"><a href="#bail-类型-hook" aria-hidden="true" class="header-anchor">#</a> Bail 类型 Hook</h4> <p>Bail类型的 Hook 包括：<code>SyncBailHook</code>、<code>AsyncSeriesBailHook</code>、<code>AsyncParallelBailHook</code>。Bail类型的 Hook 也是按回调栈顺序一次执行回调，但是如果其中一个回调函数返回结果<code>result !== undefined</code> 则退出回调栈调。代码示例如下：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token punctuation">{</span>SyncBailHook<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'tapable'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> hook <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SyncBailHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
hook<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">,</span> <span class="token parameter">name</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
hook<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">,</span> <span class="token parameter">name</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token string">'stop'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
hook<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'3'</span><span class="token punctuation">,</span> <span class="token parameter">name</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">hook</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/* output
hello 1
hello 2
 */</span>
</code></pre></div><p>通过上面的代码可以得出结论：</p> <ul><li>BailHook 中的回调是顺序执行的；</li> <li>调用call传入的参数会被每个回调函数都获取；</li> <li>当回调函数返回非undefined 才会停止回调栈的调用。</li></ul> <p>详细的流程图如下：</p> <p><img src="http://img.mukewang.com/5d076aae00017a9e05790501.png" alt=""></p> <blockquote><p>SyncBailHook类似Array.find，找到（或者发生）一件事情就停止执行；AsyncParallelBailHook类似Promise.race这里竞速场景，只要有一个回调解决了一个问题，全部都解决了。</p></blockquote> <h4 id="waterfall-类型-hook"><a href="#waterfall-类型-hook" aria-hidden="true" class="header-anchor">#</a> Waterfall 类型 Hook</h4> <p>Waterfall类型 Hook 包括 <code>SyncWaterfallHook</code>和<code>AsyncSeriesWaterfallHook</code>。类似Array.reduce效果，如果上一个回调函数的结果 <code>result !== undefined</code>，则会被作为下一个回调函数的第一个参数。代码示例如下：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token punctuation">{</span>SyncWaterfallHook<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'tapable'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> hook <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SyncWaterfallHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'arg0'</span><span class="token punctuation">,</span> <span class="token string">'arg1'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
hook<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">arg0<span class="token punctuation">,</span> arg1</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arg0<span class="token punctuation">,</span> arg1<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
hook<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">arg0<span class="token punctuation">,</span> arg1</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arg0<span class="token punctuation">,</span> arg1<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
hook<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'3'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">arg0<span class="token punctuation">,</span> arg1</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 这里 arg0 = 2</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arg0<span class="token punctuation">,</span> arg1<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 等同于 return undefined</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
hook<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'4'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">arg0<span class="token punctuation">,</span> arg1</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 这里 arg0 = 2 还是2</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arg0<span class="token punctuation">,</span> arg1<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">hook</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'Webpack'</span><span class="token punctuation">,</span> <span class="token string">'Tapable'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* console log output
Webpack Tapable 1
1 'Tapable' 2
2 'Tapable' 3
2 'Tapable' 4 */</span>
</code></pre></div><p>通过上面的代码可以得出结论：</p> <ul><li>WaterfallHook 的回调函数接受的参数来自于上一个函数结果；</li> <li>调用call传入的第一个参数会被上一个函数的非undefined结果给替换；</li> <li>当回调函数返回非undefined 不会停止回调栈的调用。</li></ul> <p>详细的流程图如下：</p> <p><img src="http://img.mukewang.com/5d076ad000010a0a06280535.png" alt=""></p> <h4 id="loop-类型-hook"><a href="#loop-类型-hook" aria-hidden="true" class="header-anchor">#</a> Loop 类型 Hook</h4> <p>这类 Hook 只有一个SyncLoopHook（虽然 Tapable 1.1.1版本中存在AsyncSeriesLoopHook，但是并没有将它 export 出来），LoopHook执行特点是不停地循环执行回调函数，直到所有函数结果 result === undefined。为了更加直观地展现 LoopHook 的执行过程，我对示例代码做了一下丰富：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token punctuation">{</span>SyncLoopHook<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'tapable'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> hook <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SyncLoopHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> callbackCalledCount1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> callbackCalledCount2 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> callbackCalledCount3 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> intent <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
hook<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'callback 1'</span><span class="token punctuation">,</span> <span class="token parameter">arg</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    callbackCalledCount1<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>callbackCalledCount1 <span class="token operator">===</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        callbackCalledCount1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        intent <span class="token operator">-=</span> <span class="token number">4</span><span class="token punctuation">;</span>
        <span class="token function">intentLog</span><span class="token punctuation">(</span><span class="token string">'&lt;/callback-1&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">intentLog</span><span class="token punctuation">(</span><span class="token string">'&lt;callback-1&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        intent <span class="token operator">+=</span> <span class="token number">4</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">'callback-1'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

hook<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'callback 2'</span><span class="token punctuation">,</span> <span class="token parameter">arg</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    callbackCalledCount2<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>callbackCalledCount2 <span class="token operator">===</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        callbackCalledCount2 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        intent <span class="token operator">-=</span> <span class="token number">4</span><span class="token punctuation">;</span>
        <span class="token function">intentLog</span><span class="token punctuation">(</span><span class="token string">'&lt;/callback-2&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">intentLog</span><span class="token punctuation">(</span><span class="token string">'&lt;callback-2&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        intent <span class="token operator">+=</span> <span class="token number">4</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">'callback-2'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

hook<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'callback 3'</span><span class="token punctuation">,</span> <span class="token parameter">arg</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    callbackCalledCount3<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>callbackCalledCount3 <span class="token operator">===</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        callbackCalledCount3 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        intent <span class="token operator">-=</span> <span class="token number">4</span><span class="token punctuation">;</span>
        <span class="token function">intentLog</span><span class="token punctuation">(</span><span class="token string">'&lt;/callback-3&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">intentLog</span><span class="token punctuation">(</span><span class="token string">'&lt;callback-3&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        intent <span class="token operator">+=</span> <span class="token number">4</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">'callback-3'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">hook</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'args'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">intentLog</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>text</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Array</span><span class="token punctuation">(</span>intent<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">...</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/* output
 &lt;callback-1&gt;
 &lt;/callback-1&gt;
 &lt;callback-2&gt;
    &lt;callback-1&gt;
    &lt;/callback-1&gt;
 &lt;/callback-2&gt;
 &lt;callback-3&gt;
    &lt;callback-1&gt;
    &lt;/callback-1&gt;
    &lt;callback-2&gt;
        &lt;callback-1&gt;
        &lt;/callback-1&gt;
    &lt;/callback-2&gt;
 &lt;/callback-3&gt;
 */</span>
</code></pre></div><p>通过上面的代码可以得出结论：</p> <ul><li>LoopHook 中的回调返回undefined（没有 return 其实就是undefined）才会跳出循环；</li> <li>所说的循环，起点是第一个回调栈的函数。</li></ul> <p>详细的流程图如下：</p> <p><img src="http://img.mukewang.com/5d076aef000151c908260538.png" alt=""></p> <h2 id="tapable-的原理解析"><a href="#tapable-的原理解析" aria-hidden="true" class="header-anchor">#</a> Tapable 的原理解析</h2> <p>Tapable 的执行流程可以分为四步：</p> <ol><li>使用tap*对事件进行注册绑定。根据类型不同，提供三种绑定的方式：tap、tapPromise、tapAsync，其中tapPromise、tapAsync为异步类 Hook 的绑定方法；</li> <li>使用call*对事件进行触发，根据类型不同，也提供了三种触发的方式：call、promise、callAsync；</li> <li>生成对应类型的代码片段（要执行的代码实际是拼字符串拼出来的）；</li> <li>生成第三步生成的代码片段。</li></ol> <p>下面以<code>SyncHook</code>源码为例，分析下整个流程。先来看下<code>lib/SyncHook.js</code> 主要代码：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">SyncHook</span> <span class="token keyword">extends</span> <span class="token class-name">Hook</span> <span class="token punctuation">{</span>
    <span class="token comment">// 错误处理，防止调用者调用异步钩子</span>
	<span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;tapAsync is not supported on a SyncHook&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">tapPromise</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;tapPromise is not supported on a SyncHook&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
    <span class="token comment">// 实现入口</span>
	<span class="token function">compile</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		factory<span class="token punctuation">.</span><span class="token function">setup</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> factory<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>首先所有的 <code>Hook</code> 都是继承自Hook类，针对同步 Hook 的事件绑定，如<code>SyncHook</code>、<code>SyncBailHook</code>、<code>SyncLoopHook</code>、<code>SyncWaterfallHook</code>, 会在子类中覆写基类Hook中 <code>tapAsync</code> 和 <code>tapPromise</code> 方法，<strong>这样做可以防止使用者在同步 <code>Hook</code> 中误用异步方法</strong>。</p> <p>下面我按照执行流程的四个步骤来分析下源码，看一下一个完整的流程中，都是调用了什么方法和怎么实现的。</p> <ol><li>绑定事件
SyncHook中绑定事件是下面的代码：</li></ol> <div class="language-javascript extra-class"><pre class="language-javascript"><code>hook<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'evt1'</span><span class="token punctuation">,</span> <span class="token parameter">arg0</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arg0<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
hook<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'evt2'</span><span class="token punctuation">,</span> <span class="token parameter">arg0</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arg0<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>下面我们来看下tap的实现，因为SyncHook是继承子Hook，所以我们找到<code>lib/Hook.js</code>中 <code>tap</code> 的实现代码：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">tap</span><span class="token punctuation">(</span><span class="token parameter">options<span class="token punctuation">,</span> fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 实际调用了_tap</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_tap</span><span class="token punctuation">(</span><span class="token string">&quot;sync&quot;</span><span class="token punctuation">,</span> options<span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">_tap</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> options<span class="token punctuation">,</span> fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 这里主要进行了一些参数的类型判断</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> options <span class="token operator">===</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        options <span class="token operator">=</span> <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span> options
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> options <span class="token operator">!==</span> <span class="token string">&quot;object&quot;</span> <span class="token operator">||</span> options <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;Invalid tap options&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> options<span class="token punctuation">.</span>name <span class="token operator">!==</span> <span class="token string">&quot;string&quot;</span> <span class="token operator">||</span> options<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;Missing name for tap&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> options<span class="token punctuation">.</span>context <span class="token operator">!==</span> <span class="token string">&quot;undefined&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">deprecateContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    options <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token punctuation">,</span> fn <span class="token punctuation">}</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 这里是注册了Interceptors(拦截器)</span>
    options <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_runRegisterInterceptors</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 参数处理完之后，调用了_insert，这是关键代码</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_insert</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>通过查阅Hook.tap和Hook._tap的代码，发现主要是做一些参数处理的工作，而主要的实现是在Hook._insert实现的：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// tapable/lib/Hook.js</span>
<span class="token function">_insert</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_resetCompilation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">let</span> before<span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> item<span class="token punctuation">.</span>before <span class="token operator">===</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			before <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">[</span>item<span class="token punctuation">.</span>before<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>before<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			before <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>before<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">let</span> stage <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> item<span class="token punctuation">.</span>stage <span class="token operator">===</span> <span class="token string">&quot;number&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			stage <span class="token operator">=</span> item<span class="token punctuation">.</span>stage<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 这里根据 stage 对事件进行一个优先级排序</span>
		<span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>taps<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
		<span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			i<span class="token operator">--</span><span class="token punctuation">;</span>
			<span class="token keyword">const</span> x <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>taps<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
			<span class="token keyword">this</span><span class="token punctuation">.</span>taps<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> x<span class="token punctuation">;</span>
			<span class="token keyword">const</span> xStage <span class="token operator">=</span> x<span class="token punctuation">.</span>stage <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>before<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>before<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					before<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">continue</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>before<span class="token punctuation">.</span>size <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token keyword">continue</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>xStage <span class="token operator">&gt;</span> stage<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">continue</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			i<span class="token operator">++</span><span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 这是找到了回调栈</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>taps<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> item<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>_insert的代码主要目的是将传入的事件推入this.taps数组，等同于：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>hook<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'event'</span><span class="token punctuation">,</span> callback<span class="token punctuation">)</span>
<span class="token comment">// → 即</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>taps<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    type<span class="token punctuation">:</span> <span class="token string">'sync'</span><span class="token punctuation">,</span>
    name<span class="token punctuation">:</span> <span class="token string">'event'</span><span class="token punctuation">,</span>
    fn<span class="token punctuation">:</span> callback
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>在基类lib/Hook.js的constructor中，可以找到一些变量初始化的代码：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">Hook</span> <span class="token punctuation">{</span>
	<span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">args <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 这里存入初始化的参数</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_args <span class="token operator">=</span> args<span class="token punctuation">;</span>
        <span class="token comment">// 这里就是回调栈用到的数组</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>taps <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment">// 拦截器数组</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>interceptors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>call <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_call<span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>promise <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_promise<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>callAsync <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_callAsync<span class="token punctuation">;</span>
        <span class="token comment">// 这个比较重要，后面拼代码会用</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>_x <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这样绑定回调函数就完成了，下面看下触发回调的时候发生了什么。</p> <ol start="2"><li>事件触发
在事件触发，我们使用同syncHook的call方法触发一个事件：</li></ol> <div class="language- extra-class"><pre class="language-text"><code>hook.call(1, 2);
</code></pre></div><p>这里的call方法，实际是通过<code>Object.defineProperties</code>添加到<code>Hook.prototype</code>上面的：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// tapable/lib/Hook.js</span>
<span class="token keyword">function</span> <span class="token function">createCompileDelegate</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">lazyCompileHook</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">this</span><span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_createCall</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

Object<span class="token punctuation">.</span><span class="token function">defineProperties</span><span class="token punctuation">(</span><span class="token class-name">Hook</span><span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token punctuation">{</span>
	_call<span class="token punctuation">:</span> <span class="token punctuation">{</span>
		value<span class="token punctuation">:</span> <span class="token function">createCompileDelegate</span><span class="token punctuation">(</span><span class="token string">&quot;call&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;sync&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		configurable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
		writable<span class="token punctuation">:</span> <span class="token boolean">true</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
	_promise<span class="token punctuation">:</span> <span class="token punctuation">{</span>
		value<span class="token punctuation">:</span> <span class="token function">createCompileDelegate</span><span class="token punctuation">(</span><span class="token string">&quot;promise&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;promise&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		configurable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
		writable<span class="token punctuation">:</span> <span class="token boolean">true</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
	_callAsync<span class="token punctuation">:</span> <span class="token punctuation">{</span>
		value<span class="token punctuation">:</span> <span class="token function">createCompileDelegate</span><span class="token punctuation">(</span><span class="token string">&quot;callAsync&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;async&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		configurable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
		writable<span class="token punctuation">:</span> <span class="token boolean">true</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>在上面的代码中，<code>Hook.prototype</code>通过对象定义属性方法<code>Object.defineProperties</code>定义了三个属性方法：<code>_call</code>、<code>_promise</code>、<code>_callAsync</code>。这三个属性的value都是通过 <code>createCompileDelegate</code>返回的一个名为<code>lazyCompileHook</code>的函数，从名字上面来猜测是「懒编译」。当我们真正调用call方法的时候，才会编译出真正的call函数。</p> <p>call函数编译用到的是<code>_createCall</code>方法，这个是在 Hook 类定义的时候就定义的方法，_createCall实际最终调用了compile方法，而通过Hook.js代码来看，compile是个需要子类重写实现的方法：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// tapable/lib/Hook.js</span>
<span class="token function">compile</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;Abstract: should be overriden&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">_createCall</span><span class="token punctuation">(</span><span class="token parameter">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        taps<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>taps<span class="token punctuation">,</span>
        interceptors<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>interceptors<span class="token punctuation">,</span>
        args<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_args<span class="token punctuation">,</span>
        type<span class="token punctuation">:</span> type
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>所以，在 Hook 中绕了一圈，我们又回到了SyncHook的类。我们再看下 SyncHook 的代码：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// lib/SyncHook.js</span>
<span class="token keyword">const</span> HookCodeFactory <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./HookCodeFactory&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">SyncHookCodeFactory</span> <span class="token keyword">extends</span> <span class="token class-name">HookCodeFactory</span> <span class="token punctuation">{</span>
	<span class="token function">content</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> onError<span class="token punctuation">,</span> onDone<span class="token punctuation">,</span> rethrowIfPossible <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">callTapsSeries</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
			<span class="token function-variable function">onError</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">i<span class="token punctuation">,</span> err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">onError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">,</span>
			onDone<span class="token punctuation">,</span>
			rethrowIfPossible
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> factory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SyncHookCodeFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">SyncHook</span> <span class="token keyword">extends</span> <span class="token class-name">Hook</span> <span class="token punctuation">{</span>
	<span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;tapAsync is not supported on a SyncHook&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token function">tapPromise</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;tapPromise is not supported on a SyncHook&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token function">compile</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		factory<span class="token punctuation">.</span><span class="token function">setup</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> factory<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
SyncHook 的compile来自是HookCodeFactory的子类SyncHookCodeFactory。在lib<span class="token operator">/</span>HookCodeFactory<span class="token punctuation">.</span>js找到setup方法：

<span class="token comment">// lib/HookCodeFactory</span>
<span class="token function">setup</span><span class="token punctuation">(</span><span class="token parameter">instance<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    instance<span class="token punctuation">.</span>_x <span class="token operator">=</span> options<span class="token punctuation">.</span>taps<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">t</span> <span class="token operator">=&gt;</span> t<span class="token punctuation">.</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这里的instance实际就是SyncHook的实例，而_x就是我们之前绑定事件时候最后的_x。</p> <ol start="4"><li>最后factory.create(options)调用了HookCodeFactory的create方法，这个方法就是实际拼接可执行 JavaScript 代码片段的，具体看下实现：</li></ol> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// lib/HookCodeFactory.js</span>
<span class="token function">create</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> fn<span class="token punctuation">;</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> <span class="token string">&quot;sync&quot;</span><span class="token punctuation">:</span>
            fn <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Function</span><span class="token punctuation">(</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">args</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token string">'&quot;use strict&quot;;\n'</span> <span class="token operator">+</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">content</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                        <span class="token function-variable function">onError</span><span class="token punctuation">:</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">throw </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>err<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">;\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
                        <span class="token function-variable function">onResult</span><span class="token punctuation">:</span> <span class="token parameter">result</span> <span class="token operator">=&gt;</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">return </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>result<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">;\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
                        resultReturns<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                        <span class="token function-variable function">onDone</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
                        rethrowIfPossible<span class="token punctuation">:</span> <span class="token boolean">true</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token string">&quot;async&quot;</span><span class="token punctuation">:</span>
            fn <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Function</span><span class="token punctuation">(</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">args</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                    after<span class="token punctuation">:</span> <span class="token string">&quot;_callback&quot;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token string">'&quot;use strict&quot;;\n'</span> <span class="token operator">+</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">content</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                        <span class="token function-variable function">onError</span><span class="token punctuation">:</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">_callback(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>err<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">);\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
                        <span class="token function-variable function">onResult</span><span class="token punctuation">:</span> <span class="token parameter">result</span> <span class="token operator">=&gt;</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">_callback(null, </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>result<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">);\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
                        <span class="token function-variable function">onDone</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token string">&quot;_callback();\n&quot;</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token string">&quot;promise&quot;</span><span class="token punctuation">:</span>
            <span class="token keyword">let</span> errorHelperUsed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token keyword">const</span> content <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">content</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                <span class="token function-variable function">onError</span><span class="token punctuation">:</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                    errorHelperUsed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">_error(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>err<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">);\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token function-variable function">onResult</span><span class="token punctuation">:</span> <span class="token parameter">result</span> <span class="token operator">=&gt;</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">_resolve(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>result<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">);\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
                <span class="token function-variable function">onDone</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token string">&quot;_resolve();\n&quot;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">let</span> code <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
            code <span class="token operator">+=</span> <span class="token string">'&quot;use strict&quot;;\n'</span><span class="token punctuation">;</span>
            code <span class="token operator">+=</span> <span class="token string">&quot;return new Promise((_resolve, _reject) =&gt; {\n&quot;</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>errorHelperUsed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                code <span class="token operator">+=</span> <span class="token string">&quot;var _sync = true;\n&quot;</span><span class="token punctuation">;</span>
                code <span class="token operator">+=</span> <span class="token string">&quot;function _error(_err) {\n&quot;</span><span class="token punctuation">;</span>
                code <span class="token operator">+=</span> <span class="token string">&quot;if(_sync)\n&quot;</span><span class="token punctuation">;</span>
                code <span class="token operator">+=</span> <span class="token string">&quot;_resolve(Promise.resolve().then(() =&gt; { throw _err; }));\n&quot;</span><span class="token punctuation">;</span>
                code <span class="token operator">+=</span> <span class="token string">&quot;else\n&quot;</span><span class="token punctuation">;</span>
                code <span class="token operator">+=</span> <span class="token string">&quot;_reject(_err);\n&quot;</span><span class="token punctuation">;</span>
                code <span class="token operator">+=</span> <span class="token string">&quot;};\n&quot;</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            code <span class="token operator">+=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            code <span class="token operator">+=</span> content<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>errorHelperUsed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                code <span class="token operator">+=</span> <span class="token string">&quot;_sync = false;\n&quot;</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            code <span class="token operator">+=</span> <span class="token string">&quot;});\n&quot;</span><span class="token punctuation">;</span>
            fn <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Function</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">args</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> code<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">deinit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> fn<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>上面create代码中的重要参数是type，而type是由 <strong>Hook</strong> 类在 <code>createCompileDelegate(&quot;call&quot;, &quot;sync&quot;)</code>的时候传入进去的，所以调用 <strong>call方法</strong>。实际type为sync，在 create 中会进入到case 'sync'的分支，在switch中用到最重要的content实际是在<code>class SyncHookCodeFactory extends HookCodeFactory</code>的时候定义的。这里我们就不继续追踪代码生成的逻辑实现了，我们可以直接在最后将 fn的源码console.log出来：<code>console.log(fn.toString())</code>，大致可以得到下面的代码：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 调用 call 的代码</span>
<span class="token keyword">const</span> hook <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'argName0'</span><span class="token punctuation">,</span> <span class="token string">'argName1'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
hook<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'evtName'</span><span class="token punctuation">,</span> <span class="token parameter">arg0</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arg0<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">hook</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'Webpack'</span><span class="token punctuation">,</span> <span class="token string">'Tapable'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 最终得到的源码是：</span>
<span class="token keyword">function</span> <span class="token function">anonymous</span><span class="token punctuation">(</span><span class="token parameter">argName0<span class="token punctuation">,</span> argName1</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> _context<span class="token punctuation">;</span>
<span class="token keyword">var</span> _x <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_x<span class="token punctuation">;</span>
<span class="token keyword">var</span> _fn0 <span class="token operator">=</span> _x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token function">_fn0</span><span class="token punctuation">(</span>argName0<span class="token punctuation">,</span> argName1<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre></div><p>上面的_fn0实际就是我们tap绑定的回调函数，argName0和argsName1就是我们实例化SyncHook传入的形参，而我们实际只是在tap的回调中用了arg0一个参数，所以输出的结果是Webpack 1。</p> <h2 id="总结"><a href="#总结" aria-hidden="true" class="header-anchor">#</a> 总结</h2> <p>Tapable 是 Webpack 的核心模块，Webpack 的所有工作流程都是通过 Tapable 来实现的。Tapable 本质上是提供了多种类型的事件绑定机制，根据不同的流程特点可以选择不同类型的 Hook 来使用。Tapable 的核心实现在绑定事件阶段跟我们平时的自定义 JavaScript事件绑定（例如EventEmitter）没有太大区别，但是在事件触发执行的时候，会临时生成可以执行的函数代码片段。通过这种实现方式，Tapable 实现了强大的事件流程控制能力，也增加了如 waterfall/parallel 系列方法，实现了异步/并行等事件流的控制能力。</p> <p><strong>本小节 Webpack 相关面试题：</strong></p> <ol><li>Webpack 的核心模块Tapable 有什么作用，是怎么实现的？</li></ol></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">9/13/2019, 2:49:43 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/0023.html" class="prev">23 怎么调试 Webpack？</a></span> <span class="next"><a href="/0025.html">25 Webpack 的 Compiler 和 Compilation</a>→
    </span></p></div> </main></div><div class="global-ui"><SWUpdatePopup></SWUpdatePopup></div></div>
    <script src="/assets/js/app.745025a3.js" defer></script><script src="/assets/js/2.d6c01b35.js" defer></script><script src="/assets/js/29.59b2df76.js" defer></script>
  </body>
</html>
